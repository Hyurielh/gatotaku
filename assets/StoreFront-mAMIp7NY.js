import{r as d,j as e,n as A,o as P,S as L,E as M,p as I}from"./vendor-CfrxxlCL.js";import{u as _,s as k,S as B}from"./index-C6A6NGoE.js";function z({onFilterChange:s,currentFilters:x={},categories:y,animes:m,onResetFilters:b}){const[n,i]=d.useState(x),[v,h]=d.useState(!1),p=t=>{const o={...x,...t,page:1};i(o),s(o)},u=t=>{p({category:t.target.value===""?void 0:t.target.value})},f=t=>{p({anime:t.target.value===""?void 0:t.target.value})},j=t=>{const o=t.target.value?parseFloat(t.target.value):void 0;p({minPrice:o})},N=t=>{const o=t.target.value?parseFloat(t.target.value):void 0;p({maxPrice:o})},w=t=>{p({sortBy:t.target.value})},r=t=>{const o=t.target.value;i(c=>({...c,search:o===""?void 0:o})),s({search:o===""?void 0:o})},a=()=>{h(!v)},l=()=>{const t={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};i(t),s(t),b&&b()};return e.jsxs("div",{className:"search-and-filters-container",children:[e.jsxs("div",{className:"filter-group mb-4",children:[e.jsx("label",{htmlFor:"search-input-desktop",className:"block text-sm font-medium text-gray-700 mb-1",children:"Buscar productos"}),e.jsx("input",{id:"search-input-desktop",type:"text",placeholder:"Buscar productos...",value:n.search||"",onChange:r,"aria-label":"Buscar productos por nombre o descripción",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsx("div",{className:"md:hidden flex justify-end mb-4",children:e.jsxs("button",{onClick:a,className:"flex items-center px-4 py-2 bg-orange-500 text-white rounded-md",children:[e.jsx(A,{className:"mr-2"})," Filtros"]})}),e.jsxs("div",{className:`
        additional-filters
        grid grid-cols-1 
        ${v?"grid":"hidden"} 
        md:grid md:grid-cols-2 md:gap-4
      `,children:[e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"category-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),e.jsxs("select",{id:"category-select",value:n.category||"",onChange:u,"aria-label":"Seleccionar categoría de producto",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),y.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]}),e.jsxs("div",{className:"filter-group flex-1 ",children:[e.jsx("label",{htmlFor:"anime-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),e.jsxs("select",{id:"anime-select",value:n.anime||"",onChange:f,"aria-label":"Seleccionar anime",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todos los Animes"}),m.map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))]})]})]}),e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"min-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Mínimo"}),e.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:n.minPrice!==void 0?n.minPrice:"",onChange:j,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"max-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Máximo"}),e.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:n.maxPrice!==void 0?n.maxPrice:"",onChange:N,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("label",{htmlFor:"sort-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Ordenar por"}),e.jsxs("select",{id:"sort-select",value:n.sortBy||"name_asc",onChange:w,"aria-label":"Ordenar productos",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"name_asc",children:"Nombre A-Z"}),e.jsx("option",{value:"name_desc",children:"Nombre Z-A"}),e.jsx("option",{value:"price_asc",children:"Precio: Menor a Mayor"}),e.jsx("option",{value:"price_desc",children:"Precio: Mayor a Menor"}),e.jsx("option",{value:"created_at",children:"Más Recientes"})]})]}),e.jsx("div",{className:"filter-group col-span-full",children:e.jsx("button",{onClick:l,className:"w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300",children:"Restablecer Filtros"})})]})]})}function T({images:s,alt:x,srcSet:y,loading:m="lazy",className:b,imageRefs:n}){const i=d.useMemo(()=>Array.isArray(s)&&s.length>0?s.map((r,a)=>typeof r=="string"?{src:r,srcSet:`${r} 320w, ${r} 640w, ${r} 1024w, ${r} 1920w`}:r.srcSet?r:{...r,srcSet:`${r.src} 320w, ${r.src} 640w, ${r.src} 1024w, ${r.src} 1920w`}):[{src:"https://via.placeholder.com/400x400?text=No+Image",srcSet:"https://via.placeholder.com/400x400?text=No+Image 320w"}],[s]),[v,h]=d.useState(0),[p,u]=d.useState([]),f=d.useRef([]);d.useEffect(()=>{h(0),u([])},[i]),d.useEffect(()=>{n&&n(f.current)},[i,n]);const j=d.useCallback(()=>{h(r=>r===i.length-1?0:r+1)},[i]),N=d.useCallback(()=>{h(r=>r===0?i.length-1:r-1)},[i]),w=d.useCallback(r=>{u(a=>[...a,r])},[i]);return e.jsxs("div",{className:`${b} relative w-full h-full overflow-hidden`,onClick:r=>r.stopPropagation(),children:[e.jsx("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:i.map((r,a)=>{const l=a===v,t=p.includes(a);return e.jsx("div",{className:`
                absolute inset-0 transition-all duration-500 ease-in-out
                ${l?"opacity-100 z-10 visible":"opacity-0 z-0 invisible"}
                ${t?"hidden":""}
              `,children:e.jsx("img",{ref:o=>f.current[a]=o,src:r.src,alt:`${x} - Image ${a+1}`,srcSet:r.srcSet,loading:m,onError:()=>w(a),className:"w-full h-full object-cover"},`img-${a}`)},`${r.src}-${a}`)})}),i.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:N,className:"absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-orange-500 transition-colors z-20","aria-label":"Previous Image",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("button",{onClick:j,className:"absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-orange-500 transition-colors z-20","aria-label":"Next Image",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),i.length>1&&e.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-20",children:i.map((r,a)=>e.jsx("button",{onClick:()=>h(a),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${a===v?"bg-orange-500":"bg-gray-300"}
              `,"aria-label":`Go to image ${a+1}`},`dot-${a}`))})]})}function W(s){return(Array.isArray(s)?s:[s]).filter(m=>m&&m.trim()!=="").map(m=>{try{return[{descriptor:"320w",width:320},{descriptor:"640w",width:640},{descriptor:"1024w",width:1024},{descriptor:"1920w",width:1920}].map(n=>`${m} ${n.descriptor}`).join(", ")}catch(b){return console.error("Error generating WebP srcset:",b),m}})}function R({product:s,className:x}){const{addItem:y}=_(),m=P.useMemo(()=>{if(!s.images||s.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const h=s.images.filter(p=>p&&p.trim()!=="");return h.length>0?h:["https://via.placeholder.com/400x400?text=No+Image"]},[s.images]),b=P.useMemo(()=>W(m),[m]),[n,i]=P.useState(!1),v=P.useRef([]);return P.useEffect(()=>{i(!1);const h=()=>{v.current.every(f=>f&&f.complete)&&i(!0)};h();const p=v.current.map((u,f)=>{if(u&&!u.complete){const j=()=>h();return u.addEventListener("load",j),{img:u,listener:j}}return null}).filter(Boolean);return()=>{p.forEach(u=>{u&&u.img.removeEventListener("load",u.listener)})}},[m]),e.jsxs("div",{className:[x,"product-card border rounded-lg overflow-hidden shadow-md transition-all duration-300 ease-in-out transform hover:scale-105 hover:shadow-2xl flex flex-col h-full relative group"].filter(Boolean).join(" "),children:[!n&&e.jsx("div",{className:"absolute inset-0 z-10 bg-gray-100 animate-pulse"}),e.jsx("div",{className:"w-full aspect-square bg-[#c8cdcc] overflow-hidden",children:e.jsx("div",{className:"w-full h-full object-cover transition-transform duration-300 ease-in-out transform group-hover:scale-110",children:e.jsx(T,{images:m,alt:s.name,srcSet:b.join(", "),loading:"lazy",className:`
              ${n?"opacity-100":"opacity-0"}
            `,imageRefs:h=>{v.current=h}})})}),e.jsxs("div",{className:"bg-white/90 py-3 px-4 flex-grow flex flex-col justify-between border-t border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-1",children:s.name}),e.jsxs("div",{className:"flex gap-1 text-xs text-orange-500 mb-1",children:[s.category_ref&&e.jsx("span",{children:s.category_ref.name}),s.anime&&e.jsxs("span",{children:["• ",s.anime.name]})]}),e.jsxs("span",{className:"text-lg font-bold text-orange-500 block mb-1",children:["C$",s.price.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-2",children:s.description})]}),e.jsxs("button",{onClick:()=>y(s),className:"w-full bg-black text-white py-2 px-2 rounded-md hover:bg-gray-900 transition-all duration-300 ease-in-out transform active:scale-95 flex items-center justify-center gap-1","aria-label":`Agregar ${s.name} al carrito`,children:[e.jsx(L,{size:16}),"Agregar"]})]})]})}function O({error:s,resetErrorBoundary:x}){return d.useEffect(()=>{console.error("StoreFront Component Error:",s)},[s]),e.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),e.jsx("p",{className:"text-red-500",children:s.message}),e.jsx("button",{onClick:x,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function K(){return e.jsx(M,{FallbackComponent:O,onReset:()=>{window.history.go(0)},children:e.jsx("main",{className:"store-front",children:e.jsx(V,{})})})}function V(){var w;const[s,x]=d.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1}));d.useEffect(()=>{const r=()=>{x({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",r),()=>{window.removeEventListener("reset-store-filters",r)}},[]);const y=d.useCallback(async()=>{var o,c;const[r,a]=await Promise.all([k.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),k.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),l=((o=r.data)==null?void 0:o.filter(g=>g.products.length>0).map(g=>({id:g.id,name:g.name})))||[],t=((c=a.data)==null?void 0:c.filter(g=>g.products.length>0).map(g=>({id:g.id,name:g.name})))||[];return{categoriesWithProducts:l,animesWithProducts:t}},[]),m=async r=>{try{const a=r.trim().toLowerCase(),l=[];l.push(`name.ilike.%${a}%`),l.push(`description.ilike.%${a}%`),l.push(`category.ilike.%${a}%`);const{data:t}=await k.from("anime").select("id").ilike("name",`%${a}%`).limit(1);return t&&t.length>0&&l.push(`anime_id.eq.${t[0].id}`),l.length>0?l.join(","):""}catch(a){return console.error("Error en búsqueda flexible:",a),""}},b=d.useCallback(async({pageParam:r=1})=>{try{const l=window.innerWidth<768?6:12,t=(r-1)*l,o=t+l-1;let c=k.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(s.search&&s.search.trim()!==""){const E=s.search.toLowerCase().trim();try{const C=await m(E);C&&(c=c.or(C))}catch(C){console.error("Error en búsqueda de productos:",C)}}s.category&&s.category.trim()!==""&&(c=c.eq("category_id",s.category)),s.anime&&s.anime.trim()!==""&&(c=c.eq("anime_id",s.anime)),s.minPrice!==void 0&&(c=c.gte("price",s.minPrice)),s.maxPrice!==void 0&&(c=c.lte("price",s.maxPrice)),c=c.order(s.sortBy.split("_")[0],{ascending:s.sortBy.endsWith("_asc")});const{data:g,error:F,count:$}=await c.range(t,o);if(F)throw F;const S=$?Math.ceil($/l):0;return{products:g||[],totalPages:S}}catch(a){return console.error("🚨 Error en búsqueda de productos:",a),{products:[],totalPages:0}}},[s]),{data:n,isLoading:i,error:v,isError:h,refetch:p}=I({queryKey:["products",s],queryFn:async()=>{const{categoriesWithProducts:r,animesWithProducts:a}=await y(),l=await b({pageParam:s.page||1});return{categoriesWithProducts:r,animesWithProducts:a,...l}},placeholderData:r=>r,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),u=d.useCallback(r=>{x(a=>({...a,...r}))},[]),f=r=>{x(a=>({...a,page:r}))},j=()=>{x({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})},N=()=>{const r=(n==null?void 0:n.totalPages)||0,a=s.page||1;if(r<=1)return null;const t=a<=3?Array.from({length:Math.min(5,r)},(c,g)=>g+1):a>=r-2?Array.from({length:5},(c,g)=>r-5+g+1):[a-2,a-1,a,a+1,a+2];return e.jsx("div",{className:"fixed bottom-0 left-0 right-0 flex justify-center items-center p-4 z-50",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>f(a-1),disabled:a===1,className:"px-3 py-2 rounded-md disabled:opacity-50 transition-colors",children:"←"}),t.map(o=>e.jsx("button",{onClick:()=>f(o),className:`px-4 py-2 rounded-md transition-all duration-150 ease-in-out ${a===o?"bg-blue-500 text-white transform scale-110":"bg-gray-200 hover:bg-blue-100"} ${o<1||o>r?"hidden":""}`,children:o},o)),e.jsx("button",{onClick:()=>f(a+1),disabled:a===r,className:"px-3 py-2 rounded-md disabled:opacity-50 transition-colors",children:"→"})]})})};return e.jsx("div",{className:"relative min-h-screen bg-white overflow-hidden",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10",children:[e.jsx(B,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, mangas, accesorios y más."}),e.jsx("div",{className:"mb-8 bg-gray-50 rounded-lg shadow-md p-6",children:i?e.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):e.jsx(z,{onFilterChange:u,currentFilters:s,categories:(n==null?void 0:n.categoriesWithProducts)||[],animes:(n==null?void 0:n.animesWithProducts)||[],onResetFilters:j})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4 transition-all duration-300 ease-in-out transform",children:(w=n==null?void 0:n.products)==null?void 0:w.map((r,a)=>e.jsx("div",{className:"transition-all duration-300 ease-in-out transform hover:scale-105 hover:z-10 hover:shadow-2xl",style:{transitionDelay:`${a*50}ms`,willChange:"transform, opacity"},children:e.jsx(R,{product:r})},r.id))}),N()]})})}export{K as default};
