import{r as c,j as e,t as A,R as $,S as z,E as D,v as B}from"./vendor-Df3h-CUU.js";import{u as M,s as I,S as O}from"./index-CHALqmmJ.js";function _({onFilterChange:t,currentFilters:m={},categories:y,animes:b,onResetFilters:v}){const[d,h]=c.useState(m),[n,x]=c.useState(!1),p=o=>{const r={...m,...o,page:1};h(r),t(r)},C=o=>{p({category:o.target.value===""?void 0:o.target.value})},N=o=>{p({anime:o.target.value===""?void 0:o.target.value})},u=o=>{const r=o.target.value?parseFloat(o.target.value):void 0;p({minPrice:r})},j=o=>{const r=o.target.value?parseFloat(o.target.value):void 0;p({maxPrice:r})},w=o=>{const r=o.target.value;h(s=>({...s,search:r===""?void 0:r})),t({search:r===""?void 0:r})},k=()=>{x(!n)},F=()=>{const o={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};h(o),t(o),v&&v()};return e.jsxs("div",{className:"search-and-filters-container pt-4",children:[e.jsx("div",{className:"filter-group mb-4",children:e.jsx("input",{id:"search-input-desktop",type:"text",placeholder:"Buscar productos...",value:d.search||"",onChange:w,"aria-label":"Buscar productos por nombre o descripción",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})}),e.jsx("div",{className:"md:hidden flex justify-end mb-4",children:e.jsxs("button",{onClick:k,className:"flex items-center px-4 py-2 bg-orange-500 text-white rounded-md",children:[e.jsx(A,{className:"mr-2"})," Filtros"]})}),e.jsxs("div",{className:`
        additional-filters
        grid grid-cols-1 
        ${n?"grid":"hidden"} 
        md:grid md:grid-cols-2 md:gap-4
      `,children:[e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"category-select",className:" my-2 block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),e.jsxs("select",{id:"category-select",value:d.category||"",onChange:C,"aria-label":"Seleccionar categoría de producto",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),y.sort((o,r)=>o.name.localeCompare(r.name)).map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]}),e.jsxs("div",{className:"filter-group flex-1 ",children:[e.jsx("label",{htmlFor:"anime-select",className:" my-2 block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),e.jsxs("select",{id:"anime-select",value:d.anime||"",onChange:N,"aria-label":"Seleccionar anime",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todos los Animes"}),b.sort((o,r)=>o.name.localeCompare(r.name)).map(o=>e.jsx("option",{value:o.id,children:o.name},o.id))]})]})]}),e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2 my-4",children:[e.jsx("div",{className:"filter-group flex-1",children:e.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:d.minPrice!==void 0?d.minPrice:"",onChange:u,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})}),e.jsx("div",{className:"filter-group flex-1",children:e.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:d.maxPrice!==void 0?d.maxPrice:"",onChange:j,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})})]}),e.jsx("div",{className:"filter-group col-span-full",children:e.jsx("button",{onClick:F,className:"w-full px-4 py-2 mt-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300",children:"Restablecer Filtros"})})]})]})}function W(t){const m=[400,800,1200];return t.map(y=>m.map(b=>`${y} ${b}w`).join(", "))}function E(t,m={}){const{maxWidth:y=1200,quality:b=70,format:v="webp"}=m;let d=t;const h=[`w-${y}`,`q-${b}`,"fo-auto","cmpr-true",`f-${v}`];return t.includes("?")?d+=`&tr=${h.join(",")}`:d+=`?tr=${h.join(",")}`,d}function V(t){return`data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg' viewBox%3D'0 0 1 1'%3E%3Cfilter id%3D'blur' filterUnits%3D'userSpaceOnUse' color-interpolation-filters%3D'sRGB'%3E%3CfeGaussianBlur stdDeviation%3D'10'%2F%3E%3C%2Ffilter%3E%3Cimage x%3D'0' y%3D'0' width%3D'100%25' height%3D'100%25' preserveAspectRatio%3D'none' href%3D'${t}' filter%3D'url(%23blur)'%2F%3E%3C%2Fsvg%3E`}function q({images:t,alt:m,srcSet:y,loading:b="lazy",className:v="",imageRefs:d,onFullyLoaded:h}){const n=$.useMemo(()=>!t||t.length===0?["https://via.placeholder.com/400x400?text=No+Image"]:t.map(r=>typeof r=="string"?E(r):typeof r=="object"&&r.src?{...r,src:E(r.src)}:r),[t]),[x,p]=c.useState(0),[C,N]=c.useState([]),u=c.useRef([]);c.useEffect(()=>{p(0)},[n]),c.useEffect(()=>{n.forEach(r=>{const s=new Image;s.src=typeof r=="string"?r:r.src})},[n]);const j=r=>{N(s=>s.includes(r)?s:[...s,r])},w=r=>{h&&h()},k=r=>{p(r)},F=()=>{p(r=>r===0?n.length-1:r-1)},o=()=>{p(r=>(r+1)%n.length)};return c.useEffect(()=>{d&&d(u.current)},[n,d]),e.jsxs("div",{className:`${v} relative w-full h-full overflow-hidden`,onClick:r=>r.stopPropagation(),children:[n.length>1&&e.jsx("button",{onClick:F,className:"absolute left-2 top-1/2 transform -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center",children:e.jsx("div",{className:"bg-orange-500/50 hover:bg-orange-600/60 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-all duration-300",children:e.jsx("span",{className:"text-white text-xl font-bold transform -translate-x-0.5",children:"‹"})})}),n.length>1&&e.jsx("button",{onClick:o,className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center",children:e.jsx("div",{className:"bg-orange-500/50 hover:bg-orange-600/60 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-all duration-300",children:e.jsx("span",{className:"text-white text-xl font-bold transform translate-x-0.5",children:"›"})})}),n.length>1&&e.jsxs("div",{className:"absolute bottom-2 right-2 z-20 bg-black/50 text-white px-2 py-1 rounded-full text-xs",children:[x+1," / ",n.length]}),e.jsx("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:n.map((r,s)=>{const a=typeof r=="string"?r:r.src,l=s===x,f=C.includes(s);return e.jsx("div",{className:`
                absolute inset-0 transition-opacity duration-300
                ${l?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}
              `,children:e.jsxs("picture",{children:[typeof r=="object"&&r.webp&&e.jsx("source",{srcSet:r.webp,type:"image/webp"}),e.jsx("img",{ref:i=>u.current[s]=i,src:f?"https://via.placeholder.com/400x400?text=Image+Error":a,alt:`${m} - imagen ${s+1}`,srcSet:typeof r=="object"?r.srcSet:void 0,loading:b,onError:()=>j(s),onLoad:()=>w(),className:"w-full h-full object-cover absolute inset-0 transform scale-100"})]})},`${a}-${s}`)})}),n.length>1&&e.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2",children:n.map((r,s)=>e.jsx("button",{onClick:()=>k(s),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${s===x?"bg-orange-500":"bg-gray-300"}
              `},s))})]})}function G({product:t,className:m}){const{addItem:y}=M(),[b,v]=c.useState(0),[d,h]=c.useState(!1),n=c.useRef(null),x=c.useRef(null),p=$.useMemo(()=>{if(!t.images||t.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const u=t.images.filter(j=>j&&j.trim()!=="");return u.length>0?u:["https://via.placeholder.com/400x400?text=No+Image"]},[t.images]),C=$.useMemo(()=>p.map((u,j)=>{const w=E(u);return{src:w,srcSet:W([w])[0],webp:E(u,{format:"webp",quality:70}),lowResSrc:V(w)}}),[p]),N=c.useCallback(()=>{n.current&&clearInterval(n.current),x.current&&clearTimeout(x.current),v(100),h(!0)},[]);return c.useEffect(()=>(v(0),h(!1),n.current=setInterval(()=>{v(u=>u<80?u+10:(clearInterval(n.current),u))},200),x.current=setTimeout(()=>{N()},5e3),()=>{n.current&&clearInterval(n.current),x.current&&clearTimeout(x.current)}),[t,N]),e.jsxs("div",{className:[m,"product-card bg-white border border-gray-200 rounded-xl overflow-hidden shadow-md hover:shadow-2xl flex flex-col h-full relative transition-all duration-300 hover:scale-[1.02] hover:-translate-y-2 group"].filter(Boolean).join(" "),children:[e.jsxs("div",{className:"w-full aspect-[4/5] sm:aspect-square overflow-hidden relative bg-gray-100",children:[e.jsx("div",{className:"absolute top-0 left-0 h-1 bg-orange-500 z-50 transition-all duration-300",style:{width:`${b}%`,opacity:d?0:1}}),e.jsx("div",{className:"absolute inset-0 bg-cover bg-center opacity-50 blur-lg transition-opacity duration-300",style:{backgroundImage:`url(${C[0].lowResSrc})`,zIndex:10,opacity:d?0:.5}}),e.jsx(q,{images:C,alt:t.name,loading:"lazy",className:"w-full h-full relative z-20 transition-opacity duration-500",onFullyLoaded:N})]}),e.jsxs("div",{className:"bg-white p-3 sm:p-4 flex-grow flex flex-col justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h2",{className:"text-sm sm:text-base font-bold text-gray-900 line-clamp-2 leading-tight",children:t.name}),e.jsxs("div",{className:"flex flex-wrap gap-1",children:[t.category_ref&&e.jsx("span",{className:"bg-orange-100 text-orange-700 px-2 py-0.5 sm:px-2 sm:py-1 rounded text-xs font-medium",children:t.category_ref.name}),t.anime&&e.jsx("span",{className:"bg-blue-100 text-blue-700 px-2 py-0.5 sm:px-2 sm:py-1 rounded text-xs font-medium",children:t.anime.name})]}),e.jsxs("div",{className:"text-lg sm:text-xl font-bold text-orange-600",children:["C$",t.price.toFixed(2)]}),e.jsx("p",{className:"text-xs sm:text-xs text-gray-600 line-clamp-2 leading-relaxed",children:t.description})]}),e.jsxs("button",{onClick:()=>y(t),className:"w-full bg-orange-500 text-white py-2 sm:py-2 px-3 sm:px-3 rounded-md flex items-center justify-center gap-2 hover:bg-orange-600 transition-all duration-200 font-medium text-sm shadow-sm hover:shadow-md mt-3","aria-label":`Agregar ${t.name} al carrito`,children:[e.jsx(z,{size:14,className:"sm:w-4 sm:h-4"}),e.jsx("span",{children:"Agregar"})]})]})]})}function U({error:t,resetErrorBoundary:m}){return c.useEffect(()=>{},[t]),e.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),e.jsx("p",{className:"text-red-500",children:t.message}),e.jsx("button",{onClick:m,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function Y(){return e.jsx(D,{FallbackComponent:U,onReset:()=>{window.history.go(0)},children:e.jsx("main",{className:"store-front",children:e.jsx(H,{})})})}function H(){var r;const[t,m]=c.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})),[y,b]=c.useState(!1);c.useEffect(()=>{const s=()=>{m({search:"",category:"",anime:"",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",s),()=>{window.removeEventListener("reset-store-filters",s)}},[]);const v=c.useCallback(async()=>{var i,P;const[s,a]=await Promise.all([I.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),I.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),l=((i=s.data)==null?void 0:i.filter(g=>g.products.length>0).map(g=>({id:g.id,name:g.name})))||[],f=((P=a.data)==null?void 0:P.filter(g=>g.products.length>0).map(g=>({id:g.id,name:g.name})))||[];return{categoriesWithProducts:l,animesWithProducts:f}},[]),d=async s=>{try{const a=s.trim().toLowerCase(),l=[];l.push(`name.ilike.%${a}%`),l.push(`description.ilike.%${a}%`),l.push(`category.ilike.%${a}%`);const{data:f}=await I.from("anime").select("id").ilike("name",`%${a}%`).limit(1);return f&&f.length>0&&l.push(`anime_id.eq.${f[0].id}`),l.length>0?l.join(","):""}catch{return""}},h=c.useCallback(async({pageParam:s=1})=>{try{const l=(s-1)*12,f=l+12-1;let i=I.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(t.search&&t.search.trim()!==""){const T=t.search.toLowerCase().trim();try{const S=await d(T);S&&(i=i.or(S))}catch{}}t.category&&t.category.trim()!==""&&(i=i.eq("category_id",t.category)),t.anime&&t.anime.trim()!==""&&(i=i.eq("anime_id",t.anime)),t.minPrice!==void 0&&(i=i.gte("price",t.minPrice)),t.maxPrice!==void 0&&(i=i.lte("price",t.maxPrice));const{data:P,error:g,count:L}=await i.range(l,f);if(g)throw g;const R=L?Math.ceil(L/12):0;return{products:P||[],totalPages:R}}catch{return{products:[],totalPages:0}}},[t]),{data:n,isLoading:x,error:p,isError:C,refetch:N}=B({queryKey:["products",t],queryFn:async()=>{const{categoriesWithProducts:s,animesWithProducts:a}=await v(),l=await h({pageParam:t.page||1});return{categoriesWithProducts:s,animesWithProducts:a,...l}},placeholderData:s=>s,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),u=c.useCallback(s=>{m(a=>({...a,...s}))},[]),j=s=>{b(!0),setTimeout(()=>{m(a=>({...a,page:s})),setTimeout(()=>{const a=document.querySelector(".products-grid-wrapper");if(a)a.scrollIntoView({behavior:"smooth",block:"start"});else{const l=document.getElementById("main-content");l&&l.scrollIntoView({behavior:"smooth",block:"start"})}setTimeout(()=>{b(!1)},300)},100)},150)},w=()=>{m({search:"",category:"",anime:"",minPrice:void 0,maxPrice:void 0,page:1})},[k,F]=c.useState(0);c.useEffect(()=>{let s=!1;const a=()=>{s||(requestAnimationFrame(()=>{const l=document.querySelector("footer"),f=window.innerHeight;if(l){const i=l.getBoundingClientRect();if(i.top<f){const P=f-i.top;F(P)}else F(0)}s=!1}),s=!0)};return a(),window.addEventListener("scroll",a,{passive:!0}),window.addEventListener("resize",a),()=>{window.removeEventListener("scroll",a),window.removeEventListener("resize",a)}},[]);const o=()=>{const s=(n==null?void 0:n.totalPages)||0,a=t.page||1;if(s<=1)return null;const f=a<=3?Array.from({length:Math.min(5,s)},(P,g)=>g+1):a>=s-2?Array.from({length:5},(P,g)=>s-5+g+1):[a-2,a-1,a,a+1,a+2];return e.jsx("div",{className:"fixed bottom-0 left-0 right-0 flex justify-center items-center py-2 z-50 bg-white/95 backdrop-blur-sm transition-transform duration-200 ease-out shadow-lg border-t border-gray-200",style:{transform:`translateY(-${k}px)`},children:e.jsxs("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[e.jsxs("span",{className:"hidden md:block text-xs text-gray-500 mr-2",children:[a,"/",s]}),e.jsx("button",{onClick:()=>j(a-1),disabled:a===1,className:"w-8 h-8 sm:w-9 sm:h-9 rounded-md bg-gray-100 hover:bg-orange-100 disabled:opacity-50 transition-colors flex items-center justify-center text-sm",children:"←"}),f.map(i=>e.jsx("button",{onClick:()=>j(i),className:`w-8 h-8 sm:w-9 sm:h-9 rounded-md transition-colors flex items-center justify-center text-sm font-medium ${a===i?"bg-orange-500 text-white shadow-sm":"bg-gray-100 hover:bg-orange-100 text-gray-700"}`,children:i},i)),e.jsx("button",{onClick:()=>j(a+1),disabled:a===s,className:"w-8 h-8 sm:w-9 sm:h-9 rounded-md bg-gray-100 hover:bg-orange-100 disabled:opacity-50 transition-colors flex items-center justify-center text-sm",children:"→"})]})})};return e.jsx("div",{className:"relative min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10",children:[e.jsx(O,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, accesorios y más."}),e.jsx("div",{className:"mb-6 bg-white rounded-xl shadow-lg p-4 border border-gray-200",children:x?e.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):e.jsx(_,{onFilterChange:u,currentFilters:t,categories:(n==null?void 0:n.categoriesWithProducts)||[],animes:(n==null?void 0:n.animesWithProducts)||[],onResetFilters:w})}),e.jsxs("div",{id:"products-section",className:"relative products-grid-wrapper",children:[y&&e.jsx("div",{className:"absolute inset-0 bg-white/70 backdrop-blur-sm z-10 flex items-center justify-center rounded-lg",children:e.jsxs("div",{className:"flex items-center space-x-2 text-orange-600",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-2 border-orange-600 border-t-transparent"}),e.jsx("span",{className:"text-sm font-medium",children:"Cargando..."})]})}),e.jsx("div",{className:`grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4 sm:gap-4 md:gap-6 transition-opacity duration-300 ${y?"opacity-50":"opacity-100"}`,children:(r=n==null?void 0:n.products)==null?void 0:r.map((s,a)=>e.jsx("div",{className:"transition-all duration-300",style:{transitionDelay:`${a*50}ms`,willChange:"transform, opacity"},children:e.jsx(G,{product:s})},s.id))})]}),o()]})})}export{Y as default};
