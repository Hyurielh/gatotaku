import{o as j,j as e,P as U,q as z,T as B,r as l,s as le}from"./vendor-CfrxxlCL.js";import{s as o,a as oe,S as ce}from"./index-CCyCvbrg.js";function de(){const[k,C]=j.useState([]),[m,w]=j.useState(""),[u,y]=j.useState(null),[b,x]=j.useState(null);j.useEffect(()=>{g()},[]);async function g(){const{data:r,error:s}=await o.from("categories").select("*").order("name");if(s){x("Error al cargar categorías");return}C(r||[])}async function S(r){if(r.preventDefault(),x(null),!m.trim())return;const{error:s}=await o.from("categories").insert({name:m.trim()});if(s){x("Error al crear categoría");return}w(""),g()}async function I(r){const{error:s}=await o.from("categories").delete().eq("id",r);if(s){x("Error al eliminar categoría");return}g()}async function N(r,s){const{error:_}=await o.from("categories").update({name:s}).eq("id",r);if(_){x("Error al actualizar categoría");return}y(null),g()}return e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Gestionar Categorías"}),b&&e.jsx("div",{className:"mb-4 p-2 bg-red-100 text-red-700 rounded",children:b}),e.jsxs("form",{onSubmit:S,className:"mb-6 flex gap-2",children:[e.jsx("input",{type:"text",value:m,onChange:r=>w(r.target.value),placeholder:"Nueva categoría",className:"flex-1 p-2 border rounded focus:ring-2 focus:ring-orange-500"}),e.jsxs("button",{type:"submit",className:"bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),"Agregar"]})]}),e.jsx("ul",{className:"space-y-2",children:k.map(r=>e.jsxs("li",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded",children:[u===r.id?e.jsx("input",{type:"text",defaultValue:r.name,onBlur:s=>N(r.id,s.target.value),onKeyDown:s=>{s.key==="Enter"&&N(r.id,s.currentTarget.value)},className:"flex-1 p-1 border rounded mr-2",autoFocus:!0}):e.jsx("span",{children:r.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>y(r.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Editar categoría",children:e.jsx(z,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>I(r.id),className:"text-red-600 hover:text-red-800","aria-label":"Eliminar categoría",children:e.jsx(B,{className:"h-5 w-5"})})]})]},r.id))})]})}function me(){const[k,C]=j.useState([]),[m,w]=j.useState(""),[u,y]=j.useState(null),[b,x]=j.useState(null);j.useEffect(()=>{g()},[]);async function g(){const{data:r,error:s}=await o.from("anime").select("*").order("name");if(s){x("Error al cargar animes");return}C(r||[])}async function S(r){if(r.preventDefault(),x(null),!m.trim())return;const{error:s}=await o.from("anime").insert({name:m.trim()});if(s){x("Error al crear anime");return}w(""),g()}async function I(r){const{error:s}=await o.from("anime").delete().eq("id",r);if(s){x("Error al eliminar anime");return}g()}async function N(r,s){const{error:_}=await o.from("anime").update({name:s}).eq("id",r);if(_){x("Error al actualizar anime");return}y(null),g()}return e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Gestionar Animes"}),b&&e.jsx("div",{className:"mb-4 p-2 bg-red-100 text-red-700 rounded",children:b}),e.jsxs("form",{onSubmit:S,className:"mb-6 flex gap-2",children:[e.jsx("input",{type:"text",value:m,onChange:r=>w(r.target.value),placeholder:"Nuevo anime",className:"flex-1 p-2 border rounded focus:ring-2 focus:ring-orange-500"}),e.jsxs("button",{type:"submit",className:"bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 flex items-center gap-2",children:[e.jsx(U,{className:"h-5 w-5"}),"Agregar"]})]}),e.jsx("ul",{className:"space-y-2",children:k.map(r=>e.jsxs("li",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded",children:[u===r.id?e.jsx("input",{type:"text",defaultValue:r.name,onBlur:s=>N(r.id,s.target.value),onKeyDown:s=>{s.key==="Enter"&&N(r.id,s.currentTarget.value)},className:"flex-1 p-1 border rounded mr-2",autoFocus:!0}):e.jsx("span",{children:r.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>y(r.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Editar anime",children:e.jsx(z,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>I(r.id),className:"text-red-600 hover:text-red-800","aria-label":"Eliminar anime",children:e.jsx(B,{className:"h-5 w-5"})})]})]},r.id))})]})}function pe(){const{session:k,loading:C}=oe(),[m,w]=l.useState(""),[u,y]=l.useState(1),[b,x]=l.useState(20),[g,S]=l.useState(0),[I,N]=l.useState(!1),[r,s]=l.useState(null),[_,G]=l.useState(()=>[]),[v,K]=l.useState([]),[O,T]=l.useState(!0),[R,V]=l.useState(()=>[]),[i,c]=l.useState(()=>({name:"",price:"",category_id:"",anime_id:"",description:"",images:[""],stock:0})),[P,q]=l.useState(null),[ue,A]=l.useState(!1),[L,M]=l.useState([]),d=(a,t="Error desconocido")=>{a instanceof le?s({message:a.message||t,details:a.details,code:a.code}):a instanceof Error?s({message:a.message||t,details:a.stack}):s({message:t}),console.error("Error detallado:",a)},H=async a=>{try{const t=a.trim().toLowerCase(),n=[];n.push(`name.ilike.%${t}%`),n.push(`description.ilike.%${t}%`),n.push(`category.ilike.%${t}%`);const{data:p}=await o.from("anime").select("id").ilike("name",`%${t}%`).limit(1);return p&&p.length>0&&n.push(`anime_id.eq.${p[0].id}`),n.length>0?n.join(","):""}catch(t){return console.error("Error en búsqueda flexible:",t),""}},$=async()=>{N(!0);try{let a=o.from("products").select(`
          *,
          category_ref:categories(id, name),
          anime:anime(id, name)
        `,{count:"exact"});if(m.trim()){const E=m.toLowerCase().trim();try{const h=await H(E);h&&(a=a.or(h))}catch(h){console.error("Error en búsqueda de productos:",h)}}const{data:t,count:n,error:p}=await a.range((u-1)*b,u*b-1).order("created_at",{ascending:!1});if(p){d(p,"Error al cargar productos");return}G(t||[]),S(n||0)}catch(a){d(a,"Error inesperado al cargar productos")}finally{N(!1)}};if(l.useEffect(()=>{$()},[m,u]),C)return e.jsx("div",{children:"Loading..."});if(!k)return e.jsx("div",{children:"Unauthorized Access"});l.useEffect(()=>{Y(),Z()},[]),l.useEffect(()=>{v.length>0&&!i.category_id&&c(a=>({...a,category_id:v[0].id}))},[v]);const J=async()=>{const a=L.map(async t=>{const n=t.name.split(".").pop(),E=`product-images/${`${Date.now()}.${n}`}`,{error:h}=await o.storage.from("product-images").upload(E,t);if(h)throw d(h,"Error al subir imágenes"),h;const{data:{publicUrl:D}}=o.storage.from("product-images").getPublicUrl(E);return D});return Promise.all(a)},Q=async a=>{if(a.preventDefault(),O){d(new Error("Cargando categorías, por favor espere"));return}if(v.length===0){d(new Error("No hay categorías disponibles. Cree una categoría primero."));return}A(!0),s(null);try{const t=i.category_id||v[0].id,n=v.find(f=>f.id===t);if(!n){d(new Error("Categoría inválida. Por favor seleccione una categoría válida.")),A(!1);return}const p=L.length>0?await J():i.images.filter(f=>f&&f.trim()!==""),E=p.length>0?p:["https://ik.imagekit.io/gatotaku/default-product-image.png"],h={name:i.name||null,description:i.description||null,price:parseFloat(i.price)||null,category_id:t||null,category:n.name,anime_id:i.anime_id||null,images:E,stock:Number(i.stock)||0},D=Object.entries(h).filter(([f,ne])=>ne===null&&f!=="anime_id"&&f!=="description").map(([f])=>f);if(D.length>0){d(new Error(`Campos requeridos faltantes: ${D.join(", ")}`)),A(!1);return}let F;try{if(P?F=await o.from("products").update(h).eq("id",P).select():F=await o.from("products").insert(h).select(),F.error){d(F.error,"Error al guardar el producto"),A(!1);return}W(),$(),s(null)}catch(f){d(f,"Error inesperado al guardar el producto")}}catch(t){d(t,"Error de validación")}finally{A(!1)}},W=()=>{var a;c({name:"",price:"",category_id:((a=v[0])==null?void 0:a.id)||"",anime_id:"",description:"",images:[""],stock:0}),q(null),M([])},X=a=>{q(null),c({name:`${a.name} (Copia)`,price:a.price.toString(),category_id:a.category_id||"",anime_id:a.anime_id||"",description:a.description||"",images:a.images||[""],stock:a.stock||0});const t=document.getElementById("product-form");t&&t.scrollIntoView({behavior:"smooth"})};async function Y(){T(!0);const{data:a,error:t}=await o.from("categories").select("*").order("name");t?d(t,"Error al cargar categorías"):K(a||[]),T(!1)}async function Z(){const{data:a,error:t}=await o.from("anime").select("*").order("name");t?d(t,"Error al cargar animes"):V(a||[])}async function ee(a){if(confirm("¿Estás seguro de que quieres eliminar este producto?"))try{const{error:t}=await o.from("products").delete().eq("id",a);t?d(t,"Error al eliminar el producto"):$()}catch(t){d(t,"Error al eliminar el producto")}}function ae(a){c({name:a.name,price:a.price.toString(),category_id:a.category_id||"",anime_id:a.anime_id||"",description:a.description,images:a.images,stock:a.stock||0}),q(a.id)}function re(a,t){const n=[...i.images];n[a]=t,c({...i,images:n})}function te(){c({...i,images:[...i.images,""]})}function se(a){const t=i.images.filter((n,p)=>p!==a);c({...i,images:t})}const ie=()=>r?e.jsxs("div",{className:"error-details",children:[e.jsx("p",{className:"error-message",children:r.message}),r.details&&e.jsxs("details",{children:[e.jsx("summary",{children:"Detalles del error"}),e.jsx("pre",{children:r.details})]}),r.code&&e.jsxs("p",{children:["Código de error: ",r.code]})]}):null;return e.jsxs("div",{className:"admin-panel",children:[e.jsx(ce,{title:"Panel de Administración",description:"Panel de administración de GATOTAKU"}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Panel de Administración"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 mb-8",children:[e.jsx(de,{}),e.jsx(me,{})]}),r&&e.jsx("div",{className:"mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded",children:ie()}),e.jsxs("form",{onSubmit:Q,id:"product-form",className:"bg-white p-6 rounded-lg shadow-md mb-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:P?"Editar Producto":"Nuevo Producto"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre"}),e.jsx("input",{type:"text",value:i.name,onChange:a=>c({...i,name:a.target.value}),className:"w-full p-2 border rounded",required:!0})]}),e.jsxs("div",{className:"mb-4 flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Precio"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"C$"})}),e.jsx("input",{type:"number",name:"price",step:"0.01",value:i.price,onChange:a=>c({...i,price:a.target.value}),className:"mt-1 block w-full pl-8 pr-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm"})]})]}),e.jsxs("div",{className:"w-32",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Stock"}),e.jsx("input",{type:"number",name:"stock",value:i.stock,onChange:a=>c({...i,stock:parseInt(a.target.value)||0}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm",min:"0"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),e.jsxs("select",{value:i.category_id,onChange:a=>c({...i,category_id:a.target.value}),className:"w-full p-2 border rounded",required:!0,children:[e.jsx("option",{value:"",children:"Selecciona una categoría"}),v.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),e.jsxs("select",{value:i.anime_id,onChange:a=>c({...i,anime_id:a.target.value}),className:"w-full p-2 border rounded",required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un anime"}),R.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción"}),e.jsx("textarea",{value:i.description,onChange:a=>c({...i,description:a.target.value}),className:"w-full p-2 border rounded",rows:3,required:!0})]}),e.jsxs("div",{className:"mb-4",children:[i.images.map((a,t)=>e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("input",{type:"url",value:a,onChange:n=>re(t,n.target.value),className:"flex-1 p-2 border rounded",placeholder:"URL de la imagen",required:!0}),e.jsx("button",{type:"button",onClick:()=>se(t),className:"px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600","aria-label":"Eliminar imagen",children:e.jsx("i",{className:"fas fa-trash"})})]},t)),e.jsxs("button",{type:"button",onClick:te,className:"mt-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:[e.jsx("i",{className:"fas fa-plus mr-2"}),"Agregar imagen"]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[P&&e.jsx("button",{type:"button",onClick:()=>{c({name:"",price:"",category_id:"",anime_id:"",description:"",images:[""],stock:0}),q(null)},className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Cancelar"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600",children:[P?"Actualizar":"Crear"," Producto"]})]})]}),e.jsx("div",{className:"search-bar mb-4 flex items-center space-x-4",children:e.jsx("input",{type:"text",placeholder:"Buscar productos...",value:m,onChange:a=>{w(a.target.value),y(1)},className:"flex-grow p-2 border rounded-md"})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Producto"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Precio"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Categoría"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Anime"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Stock"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:_.map(a=>{var t,n;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:a.images[0],alt:a.name,className:"h-10 w-10 rounded-full object-cover"}),e.jsx("div",{className:"ml-4",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a.name})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm text-gray-900",children:["$",a.price.toFixed(2)]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800",children:(t=a.category_ref)==null?void 0:t.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800",children:(n=a.anime)==null?void 0:n.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:a.stock})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:[e.jsx("button",{onClick:()=>ae(a),className:"text-indigo-600 hover:text-indigo-900 mr-4","aria-label":"Editar producto",children:e.jsx("i",{className:"fas fa-edit"})}),e.jsx("button",{onClick:()=>X(a),className:"text-green-600 hover:text-green-900 mr-4","aria-label":"Copiar producto",children:e.jsx("i",{className:"fas fa-copy"})}),e.jsx("button",{onClick:()=>ee(a.id),className:"text-red-600 hover:text-red-900","aria-label":"Eliminar producto",children:e.jsx("i",{className:"fas fa-trash"})})]})]},a.id)})})]})}),e.jsxs("div",{className:"pagination flex justify-center items-center space-x-4 mt-4",children:[e.jsx("button",{onClick:()=>y(u-1),disabled:u===1,className:"px-4 py-2 bg-orange-500 text-white rounded-md disabled:opacity-50",children:"Anterior"}),e.jsxs("span",{className:"text-gray-700",children:["Página ",u," de ",Math.ceil(g/b)]}),e.jsx("button",{onClick:()=>y(u+1),disabled:u*b>=g,className:"px-4 py-2 bg-orange-500 text-white rounded-md disabled:opacity-50",children:"Siguiente"})]})]})]})}export{pe as default};
