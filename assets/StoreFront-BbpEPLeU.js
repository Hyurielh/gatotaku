import{r as m,j as e,k,S as $,E,l as A}from"./vendor-ChWjZVFy.js";import{u as I,s as C,S as _,C as B}from"./index-CeRjcbF2.js";function M({onFilterChange:s,currentFilters:d={},categories:p,animes:l,onResetFilters:x}){const[t,u]=m.useState(d),h=r=>{const a={...d,...r};u(a),s(a)},w=r=>{h({category:r.target.value===""?void 0:r.target.value})},f=r=>{h({anime:r.target.value===""?void 0:r.target.value})},b=r=>{const a=r.target.value?parseFloat(r.target.value):void 0;h({minPrice:a})},j=r=>{const a=r.target.value?parseFloat(r.target.value):void 0;h({maxPrice:a})},v=r=>{h({sortBy:r.target.value})},n=r=>{const a=r.target.value;u(o=>({...o,search:a===""?void 0:a})),s({search:a===""?void 0:a})},c=()=>{const r={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};u(r),s(r),x&&x()};return e.jsxs("div",{className:"search-and-filters grid grid-cols-1 md:grid-cols-3 gap-4","aria-label":"Filtros de búsqueda",children:[e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"search-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Buscar productos"}),e.jsx("input",{id:"search-input",type:"text",placeholder:"Buscar productos...",value:t.search||"",onChange:n,"aria-label":"Buscar productos por nombre o descripción",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"category-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),e.jsxs("select",{id:"category-select",value:t.category||"",onChange:w,"aria-label":"Seleccionar categoría de producto",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),p.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"anime-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),e.jsxs("select",{id:"anime-select",value:t.anime||"",onChange:f,"aria-label":"Seleccionar anime",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todos los Animes"}),l.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"min-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Mínimo"}),e.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:t.minPrice!==void 0?t.minPrice:"",onChange:b,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"max-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Máximo"}),e.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:t.maxPrice!==void 0?t.maxPrice:"",onChange:j,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"sort-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Ordenar por"}),e.jsxs("select",{id:"sort-select",value:t.sortBy||"name_asc",onChange:v,"aria-label":"Ordenar productos",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"name_asc",children:"Nombre A-Z"}),e.jsx("option",{value:"name_desc",children:"Nombre Z-A"}),e.jsx("option",{value:"price_asc",children:"Precio: Menor a Mayor"}),e.jsx("option",{value:"price_desc",children:"Precio: Mayor a Menor"})]})]}),e.jsx("div",{className:"filter-group col-span-full flex justify-center mt-4",children:e.jsx("button",{onClick:c,className:"bg-orange-500 text-white px-4 py-2 rounded-md hover:bg-orange-600 transition-colors",children:"Restablecer Filtros"})})]})}function L({images:s,alt:d,srcSet:p,loading:l="lazy",className:x}){const t=m.useMemo(()=>Array.isArray(s)&&s.length>0?s.map((n,c)=>typeof n=="string"?{src:n,srcSet:`${n} 320w, ${n} 640w, ${n} 1024w, ${n} 1920w`}:n.srcSet?n:{...n,srcSet:`${n.src} 320w, ${n.src} 640w, ${n.src} 1024w, ${n.src} 1920w`}):[{src:"https://via.placeholder.com/400x400?text=No+Image",srcSet:"https://via.placeholder.com/400x400?text=No+Image 320w"}],[s]),[u,h]=m.useState(0),[w,f]=m.useState([]);m.useEffect(()=>{h(0),f([])},[t]);const b=m.useCallback(()=>{h(n=>n===t.length-1?0:n+1)},[t]),j=m.useCallback(()=>{h(n=>n===0?t.length-1:n-1)},[t]),v=m.useCallback(n=>{f(c=>[...c,n])},[t]);return e.jsxs("div",{className:`${x} relative w-full h-full overflow-hidden`,onClick:n=>n.stopPropagation(),children:[e.jsx("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:t.map((n,c)=>{const r=c===u,a=w.includes(c);return e.jsx("div",{className:`
                absolute inset-0 transition-all duration-500 ease-in-out
                ${r?"opacity-100 z-10 visible":"opacity-0 z-0 invisible"}
                ${a?"hidden":""}
              `,children:e.jsx("img",{src:n.src,alt:`${d} - Image ${c+1}`,srcSet:n.srcSet,loading:l,onError:()=>v(c),className:"w-full h-full object-cover"},`img-${c}`)},`${n.src}-${c}`)})}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:j,className:"absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-orange-500 transition-colors z-20","aria-label":"Previous Image",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("button",{onClick:b,className:"absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-orange-500 transition-colors z-20","aria-label":"Next Image",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),t.length>1&&e.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-20",children:t.map((n,c)=>e.jsx("button",{onClick:()=>h(c),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${c===u?"bg-orange-500":"bg-gray-300"}
              `,"aria-label":`Go to image ${c+1}`},`dot-${c}`))})]})}function T(s){return(Array.isArray(s)?s:[s]).filter(l=>l&&l.trim()!=="").map(l=>{try{return[{descriptor:"320w",width:320},{descriptor:"640w",width:640},{descriptor:"1024w",width:1024},{descriptor:"1920w",width:1920}].map(t=>`${l} ${t.descriptor}`).join(", ")}catch(x){return console.error("Error generating WebP srcset:",x),l}})}function W({product:s,className:d}){const{addItem:p}=I(),l=k.useMemo(()=>{if(!s.images||s.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const t=s.images.filter(u=>u&&u.trim()!=="");return t.length>0?t:["https://via.placeholder.com/400x400?text=No+Image"]},[s.images]),x=k.useMemo(()=>T(l),[l]);return e.jsxs("div",{className:[d,"product-card border rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col h-full"].filter(Boolean).join(" "),children:[e.jsx("div",{className:"w-full aspect-square",children:e.jsx("div",{className:"w-full h-full object-cover",children:e.jsx(L,{images:l,alt:s.name,srcSet:x.join(", "),loading:"lazy"})})}),e.jsxs("div",{className:"p-3 flex-grow flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-1",children:s.name}),e.jsxs("div",{className:"flex gap-1 text-xs text-orange-500 mb-1",children:[s.category_ref&&e.jsx("span",{children:s.category_ref.name}),s.anime&&e.jsxs("span",{children:["• ",s.anime.name]})]}),e.jsxs("span",{className:"text-lg font-bold text-orange-500 block mb-1",children:["C$",s.price.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-2",children:s.description})]}),e.jsxs("button",{onClick:()=>p(s),className:"w-full bg-black text-white py-1 px-2 rounded-md hover:bg-gray-900 transition-colors flex items-center justify-center gap-1 text-xs","aria-label":`Agregar ${s.name} al carrito`,children:[e.jsx($,{size:16}),"Agregar"]})]})]})}function z({error:s,resetErrorBoundary:d}){return m.useEffect(()=>{console.error("StoreFront Component Error:",s)},[s]),e.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),e.jsx("p",{className:"text-red-500",children:s.message}),e.jsx("button",{onClick:d,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function G(){return e.jsx(E,{FallbackComponent:z,onReset:()=>{window.history.go(0)},children:e.jsx(O,{})})}function O(){const[s,d]=m.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1}));m.useEffect(()=>{const r=()=>{d({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",r),()=>{window.removeEventListener("reset-store-filters",r)}},[]);const p=m.useCallback(async()=>{var N,y;const[r,a]=await Promise.all([C.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),C.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),o=((N=r.data)==null?void 0:N.filter(g=>g.products.length>0).map(g=>({id:g.id,name:g.name})))||[],i=((y=a.data)==null?void 0:y.filter(g=>g.products.length>0).map(g=>({id:g.id,name:g.name})))||[];return{categoriesWithProducts:o,animesWithProducts:i}},[]),l=async r=>{try{const a=r.trim().toLowerCase(),o=[];o.push(`name.ilike.%${a}%`),o.push(`description.ilike.%${a}%`),o.push(`category.ilike.%${a}%`);const{data:i}=await C.from("anime").select("id").ilike("name",`%${a}%`).limit(1);return i&&i.length>0&&o.push(`anime_id.eq.${i[0].id}`),o.length>0?o.join(","):""}catch(a){return console.error("Error en búsqueda flexible:",a),""}},x=m.useCallback(async({pageParam:r=1})=>{try{const a=(r-1)*12,o=a+12-1;let i=C.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(s.search&&s.search.trim()!==""){const S=s.search.toLowerCase().trim();try{const P=await l(S);P&&(i=i.or(P))}catch(P){console.error("Error en búsqueda de productos:",P)}}s.category&&s.category.trim()!==""&&(i=i.eq("category_id",s.category)),s.anime&&s.anime.trim()!==""&&(i=i.eq("anime_id",s.anime)),s.minPrice!==void 0&&(i=i.gte("price",s.minPrice)),s.maxPrice!==void 0&&(i=i.lte("price",s.maxPrice)),i=i.order(s.sortBy.split("_")[0],{ascending:s.sortBy.endsWith("_asc")});const{data:N,error:y,count:g}=await i.range(a,o);if(y)throw y;const F=g?Math.ceil(g/12):0;return{products:N||[],totalPages:F}}catch(a){return console.error("🚨 Error en búsqueda de productos:",a),{products:[],totalPages:0}}},[s]),{data:t,isLoading:u,error:h,isError:w,refetch:f}=A({queryKey:["products",s],queryFn:async()=>{const{categoriesWithProducts:r,animesWithProducts:a}=await p(),o=await x({pageParam:s.page||1});return{categoriesWithProducts:r,animesWithProducts:a,...o}},placeholderData:r=>r,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),b=m.useCallback(r=>{d(a=>({...a,...r}))},[]),j=r=>{d(a=>({...a,page:r}))},v=()=>{d({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})},n=()=>u?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-orange-500"})}):h?e.jsx("div",{className:"text-center text-red-500 py-8",children:"Error al cargar productos"}):t!=null&&t.products.length?e.jsx("div",{className:`grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4
                    gap-2 sm:gap-3 md:gap-4 
                    w-full px-1 sm:px-2 md:px-4`,children:t.products.map(r=>e.jsx(W,{product:r,className:"w-full h-full"},r.id))}):e.jsx("div",{className:"text-center text-gray-500 py-8",children:"No hay productos disponibles"}),c=()=>{const r=(t==null?void 0:t.totalPages)||0,a=s.page||1;return r<=1?null:e.jsx("div",{className:"flex justify-center mt-8 space-x-2",children:Array.from({length:r},(o,i)=>i+1).map(o=>e.jsx("button",{onClick:()=>j(o),className:`px-4 py-2 rounded-md ${a===o?"bg-blue-500 text-white":"bg-gray-200"}`,children:o},o))})};return e.jsxs("div",{className:"bg-white min-h-screen",children:[e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx(_,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, mangas, accesorios y más."}),e.jsx("div",{className:"mb-8 bg-gray-50 rounded-lg shadow-md p-6",children:u?e.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):e.jsx(M,{onFilterChange:b,currentFilters:s,categories:(t==null?void 0:t.categoriesWithProducts)||[],animes:(t==null?void 0:t.animesWithProducts)||[],onResetFilters:v})}),n(),c()]}),e.jsx(B,{})]})}export{G as default};
