import{r as i,j as r,o as R,p as E,S as A,E as M,q as _}from"./vendor-C12UJ_lp.js";import{u as T,s as k,S as B}from"./index-C3zs0VYE.js";function z({onFilterChange:t,currentFilters:g={},categories:j,animes:y,onResetFilters:b}){const[n,f]=i.useState(g),[o,x]=i.useState(!1),h=e=>{const a={...g,...e,page:1};f(a),t(a)},w=e=>{h({category:e.target.value===""?void 0:e.target.value})},p=e=>{h({anime:e.target.value===""?void 0:e.target.value})},c=e=>{const a=e.target.value?parseFloat(e.target.value):void 0;h({minPrice:a})},v=e=>{const a=e.target.value?parseFloat(e.target.value):void 0;h({maxPrice:a})},P=e=>{h({sortBy:e.target.value})},C=e=>{const a=e.target.value;f(m=>({...m,search:a===""?void 0:a})),t({search:a===""?void 0:a})},N=()=>{x(!o)},s=()=>{const e={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};f(e),t(e),b&&b()};return r.jsxs("div",{className:"search-and-filters-container",children:[r.jsxs("div",{className:"filter-group mb-4",children:[r.jsx("label",{htmlFor:"search-input-desktop",className:"block text-sm font-medium text-gray-700 mb-1",children:"Buscar productos"}),r.jsx("input",{id:"search-input-desktop",type:"text",placeholder:"Buscar productos...",value:n.search||"",onChange:C,"aria-label":"Buscar productos por nombre o descripción",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),r.jsx("div",{className:"md:hidden flex justify-end mb-4",children:r.jsxs("button",{onClick:N,className:"flex items-center px-4 py-2 bg-orange-500 text-white rounded-md",children:[r.jsx(R,{className:"mr-2"})," Filtros"]})}),r.jsxs("div",{className:`
        additional-filters
        grid grid-cols-1 
        ${o?"grid":"hidden"} 
        md:grid md:grid-cols-2 md:gap-4
      `,children:[r.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[r.jsxs("div",{className:"filter-group flex-1",children:[r.jsx("label",{htmlFor:"category-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),r.jsxs("select",{id:"category-select",value:n.category||"",onChange:w,"aria-label":"Seleccionar categoría de producto",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[r.jsx("option",{value:"",children:"Todas las categorías"}),j.sort((e,a)=>e.name.localeCompare(a.name)).map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})]}),r.jsxs("div",{className:"filter-group flex-1 ",children:[r.jsx("label",{htmlFor:"anime-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),r.jsxs("select",{id:"anime-select",value:n.anime||"",onChange:p,"aria-label":"Seleccionar anime",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[r.jsx("option",{value:"",children:"Todos los Animes"}),y.sort((e,a)=>e.name.localeCompare(a.name)).map(e=>r.jsx("option",{value:e.id,children:e.name},e.id))]})]})]}),r.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[r.jsxs("div",{className:"filter-group flex-1",children:[r.jsx("label",{htmlFor:"min-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Mínimo"}),r.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:n.minPrice!==void 0?n.minPrice:"",onChange:c,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),r.jsxs("div",{className:"filter-group flex-1",children:[r.jsx("label",{htmlFor:"max-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Máximo"}),r.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:n.maxPrice!==void 0?n.maxPrice:"",onChange:v,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]})]}),r.jsxs("div",{className:"col-span-full",children:[r.jsx("label",{htmlFor:"sort-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Ordenar por"}),r.jsxs("select",{id:"sort-select",value:n.sortBy||"name_asc",onChange:P,"aria-label":"Ordenar productos",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[r.jsx("option",{value:"name_asc",children:"Nombre A-Z"}),r.jsx("option",{value:"name_desc",children:"Nombre Z-A"}),r.jsx("option",{value:"price_asc",children:"Precio: Menor a Mayor"}),r.jsx("option",{value:"price_desc",children:"Precio: Mayor a Menor"}),r.jsx("option",{value:"created_at",children:"Más Recientes"})]})]}),r.jsx("div",{className:"filter-group col-span-full",children:r.jsx("button",{onClick:s,className:"w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300",children:"Restablecer Filtros"})})]})]})}function D({images:t,alt:g,srcSet:j,loading:y="lazy",className:b="",imageRefs:n,onFullyLoaded:f}){const o=E.useMemo(()=>!t||t.length===0?["https://via.placeholder.com/400x400?text=No+Image"]:t,[t]),[x,h]=i.useState(0),[w,p]=i.useState([]),c=i.useRef([]);i.useEffect(()=>{h(0)},[o]),i.useEffect(()=>{o.forEach(e=>{const a=new Image;a.src=typeof e=="string"?e:e.src})},[o]);const v=e=>{p(a=>a.includes(e)?a:[...a,e])},P=e=>{f&&f()},C=e=>{h(e)},N=()=>{h(e=>e===0?o.length-1:e-1)},s=()=>{h(e=>(e+1)%o.length)};return i.useEffect(()=>{n&&n(c.current)},[o,n]),r.jsxs("div",{className:`${b} relative w-full h-full overflow-hidden`,onClick:e=>e.stopPropagation(),children:[o.length>1&&r.jsx("button",{onClick:N,className:"absolute left-0 top-1/2 transform -translate-y-1/2 z-20 w-16 h-16 flex items-center justify-center",children:r.jsx("div",{className:"bg-orange-500/70 hover:bg-orange-600/80 rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all duration-300",children:r.jsx("span",{className:"text-white text-3xl font-bold transform -translate-x-0.5",children:"‹"})})}),o.length>1&&r.jsx("button",{onClick:s,className:"absolute right-0 top-1/2 transform -translate-y-1/2 z-20 w-16 h-16 flex items-center justify-center",children:r.jsx("div",{className:"bg-orange-500/70 hover:bg-orange-600/80 rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all duration-300",children:r.jsx("span",{className:"text-white text-3xl font-bold transform translate-x-0.5",children:"›"})})}),r.jsx("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:o.map((e,a)=>{const m=typeof e=="string"?e:e.src,u=a===x,l=w.includes(a);return r.jsx("div",{className:`
                absolute inset-0 transition-opacity duration-300
                ${u?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}
              `,children:r.jsxs("picture",{children:[typeof e=="object"&&e.webp&&r.jsx("source",{srcSet:e.webp,type:"image/webp"}),r.jsx("img",{ref:d=>c.current[a]=d,src:l?"https://via.placeholder.com/400x400?text=Image+Error":m,alt:`${g} - imagen ${a+1}`,srcSet:typeof e=="object"?e.srcSet:void 0,loading:y,onError:()=>v(a),onLoad:()=>P(),className:"w-full h-full object-cover absolute inset-0 transform scale-100"})]})},`${m}-${a}`)})}),o.length>1&&r.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2",children:o.map((e,a)=>r.jsx("button",{onClick:()=>C(a),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${a===x?"bg-orange-500":"bg-gray-300"}
              `},a))})]})}function W(t){const g=[400,800,1200];return t.map(j=>g.map(y=>`${j} ${y}w`).join(", "))}function O(t){return t.toLowerCase().endsWith(".webp"),t}function V(t){return`data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg' viewBox%3D'0 0 1 1'%3E%3Cfilter id%3D'blur' filterUnits%3D'userSpaceOnUse' color-interpolation-filters%3D'sRGB'%3E%3CfeGaussianBlur stdDeviation%3D'10'%2F%3E%3C%2Ffilter%3E%3Cimage x%3D'0' y%3D'0' width%3D'100%25' height%3D'100%25' preserveAspectRatio%3D'none' href%3D'${t}' filter%3D'url(%23blur)'%2F%3E%3C%2Fsvg%3E`}function q({product:t,className:g}){const{addItem:j}=T(),[y,b]=i.useState(0),[n,f]=i.useState(!1),o=i.useRef(null),x=i.useRef(null),h=E.useMemo(()=>{if(!t.images||t.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const c=t.images.filter(v=>v&&v.trim()!=="");return c.length>0?c:["https://via.placeholder.com/400x400?text=No+Image"]},[t.images]),w=E.useMemo(()=>h.map((c,v)=>({src:c,srcSet:W([c])[0],webp:O(c),lowResSrc:V(c)})),[h]),p=i.useCallback(()=>{o.current&&clearInterval(o.current),x.current&&clearTimeout(x.current),b(100),f(!0)},[]);return i.useEffect(()=>(b(0),f(!1),o.current=setInterval(()=>{b(c=>c<80?c+10:(clearInterval(o.current),c))},200),x.current=setTimeout(()=>{p()},5e3),()=>{o.current&&clearInterval(o.current),x.current&&clearTimeout(x.current)}),[t,p]),r.jsxs("div",{className:[g,"product-card border rounded-lg overflow-hidden shadow-md flex flex-col h-full relative no-transform transition-all duration-300"].filter(Boolean).join(" "),children:[r.jsxs("div",{className:"w-full aspect-square overflow-hidden relative bg-gray-100",children:[r.jsx("div",{className:"absolute top-0 left-0 h-1 bg-orange-500 z-50 transition-all duration-300",style:{width:`${y}%`,opacity:n?0:1}}),r.jsx("div",{className:"absolute inset-0 bg-cover bg-center opacity-50 blur-lg transition-opacity duration-300",style:{backgroundImage:`url(${w[0].lowResSrc})`,zIndex:10,opacity:n?0:.5}}),r.jsx(D,{images:w,alt:t.name,loading:"lazy",className:"w-full h-full relative z-20 transition-opacity duration-500",onFullyLoaded:p})]}),r.jsxs("div",{className:"bg-white/90 py-3 px-4 flex-grow flex flex-col justify-between border-t border-gray-200",children:[r.jsxs("div",{children:[r.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-1",children:t.name}),r.jsxs("div",{className:"flex gap-1 text-xs text-orange-500 mb-1",children:[t.category_ref&&r.jsx("span",{children:t.category_ref.name}),t.anime&&r.jsxs("span",{children:["• ",t.anime.name]})]}),r.jsxs("span",{className:"text-lg font-bold text-orange-500 block mb-1",children:["C$",t.price.toFixed(2)]}),r.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-2",children:t.description})]}),r.jsxs("button",{onClick:()=>j(t),className:"w-full bg-black text-white py-2 px-2 rounded-md flex items-center justify-center gap-1 hover:bg-gray-800 transition-colors","aria-label":`Agregar ${t.name} al carrito`,children:[r.jsx(A,{size:16}),"Agregar"]})]})]})}function G({error:t,resetErrorBoundary:g}){return i.useEffect(()=>{console.error("StoreFront Component Error:",t)},[t]),r.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[r.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),r.jsx("p",{className:"text-red-500",children:t.message}),r.jsx("button",{onClick:g,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function Z(){return r.jsx(M,{FallbackComponent:G,onReset:()=>{window.history.go(0)},children:r.jsx("main",{className:"store-front",children:r.jsx(U,{})})})}function U(){var N;const[t,g]=i.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1}));i.useEffect(()=>{const s=()=>{g({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",s),()=>{window.removeEventListener("reset-store-filters",s)}},[]);const j=i.useCallback(async()=>{var u,l;const[s,e]=await Promise.all([k.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),k.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),a=((u=s.data)==null?void 0:u.filter(d=>d.products.length>0).map(d=>({id:d.id,name:d.name})))||[],m=((l=e.data)==null?void 0:l.filter(d=>d.products.length>0).map(d=>({id:d.id,name:d.name})))||[];return{categoriesWithProducts:a,animesWithProducts:m}},[]),y=async s=>{try{const e=s.trim().toLowerCase(),a=[];a.push(`name.ilike.%${e}%`),a.push(`description.ilike.%${e}%`),a.push(`category.ilike.%${e}%`);const{data:m}=await k.from("anime").select("id").ilike("name",`%${e}%`).limit(1);return m&&m.length>0&&a.push(`anime_id.eq.${m[0].id}`),a.length>0?a.join(","):""}catch(e){return console.error("Error en búsqueda flexible:",e),""}},b=i.useCallback(async({pageParam:s=1})=>{try{const a=window.innerWidth<768?6:12,m=(s-1)*a,u=m+a-1;let l=k.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(t.search&&t.search.trim()!==""){const L=t.search.toLowerCase().trim();try{const F=await y(L);F&&(l=l.or(F))}catch(F){console.error("Error en búsqueda de productos:",F)}}t.category&&t.category.trim()!==""&&(l=l.eq("category_id",t.category)),t.anime&&t.anime.trim()!==""&&(l=l.eq("anime_id",t.anime)),t.minPrice!==void 0&&(l=l.gte("price",t.minPrice)),t.maxPrice!==void 0&&(l=l.lte("price",t.maxPrice)),l=l.order(t.sortBy.split("_")[0],{ascending:t.sortBy.endsWith("_asc")});const{data:d,error:S,count:I}=await l.range(m,u);if(S)throw S;const $=I?Math.ceil(I/a):0;return{products:d||[],totalPages:$}}catch(e){return console.error("🚨 Error en búsqueda de productos:",e),{products:[],totalPages:0}}},[t]),{data:n,isLoading:f,error:o,isError:x,refetch:h}=_({queryKey:["products",t],queryFn:async()=>{const{categoriesWithProducts:s,animesWithProducts:e}=await j(),a=await b({pageParam:t.page||1});return{categoriesWithProducts:s,animesWithProducts:e,...a}},placeholderData:s=>s,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),w=i.useCallback(s=>{g(e=>({...e,...s}))},[]),p=s=>{g(e=>({...e,page:s}))},c=()=>{g({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})},[v,P]=i.useState(!0);i.useEffect(()=>{const s=()=>{const e=document.querySelector("footer"),a=window.innerHeight;if(e){const u=e.getBoundingClientRect().top<a;P(!u)}};return s(),window.addEventListener("scroll",s),window.addEventListener("resize",s),()=>{window.removeEventListener("scroll",s),window.removeEventListener("resize",s)}},[]);const C=()=>{const s=(n==null?void 0:n.totalPages)||0,e=t.page||1;if(s<=1)return null;const m=e<=3?Array.from({length:Math.min(5,s)},(l,d)=>d+1):e>=s-2?Array.from({length:5},(l,d)=>s-5+d+1):[e-2,e-1,e,e+1,e+2];return r.jsx("div",{className:`${v?"fixed":"relative"} bottom-0 left-0 right-0 flex justify-center items-center p-4 z-50`,children:r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("button",{onClick:()=>p(e-1),disabled:e===1,className:"px-3 py-2 rounded-md disabled:opacity-50 transition-colors",children:"←"}),m.map(u=>r.jsx("button",{onClick:()=>p(u),className:`px-4 py-2 rounded-md transition-all duration-150 ease-in-out ${e===u?"bg-blue-500 text-white transform scale-110":"bg-gray-200 hover:bg-blue-100"} ${u<1||u>s?"hidden":""}`,children:u},u)),r.jsx("button",{onClick:()=>p(e+1),disabled:e===s,className:"px-3 py-2 rounded-md disabled:opacity-50 transition-colors",children:"→"})]})})};return r.jsx("div",{className:"relative min-h-screen bg-white overflow-hidden",children:r.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10",children:[r.jsx(B,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, mangas, accesorios y más."}),r.jsx("div",{className:"mb-8 bg-gray-50 rounded-lg shadow-md p-6",children:f?r.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):r.jsx(z,{onFilterChange:w,currentFilters:t,categories:(n==null?void 0:n.categoriesWithProducts)||[],animes:(n==null?void 0:n.animesWithProducts)||[],onResetFilters:c})}),r.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4 transition-all duration-300 ease-in-out transform",children:(N=n==null?void 0:n.products)==null?void 0:N.map((s,e)=>r.jsx("div",{className:"transition-all duration-300",style:{transitionDelay:`${e*50}ms`,willChange:"transform, opacity"},children:r.jsx(q,{product:s})},s.id))}),C()]})})}export{Z as default};
