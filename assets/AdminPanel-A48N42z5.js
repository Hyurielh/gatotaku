import{o as f,j as e,P as L,q as z,T as B,r as n,s as ie}from"./vendor-CfrxxlCL.js";import{s as l,a as ne,S as le}from"./index-D5PDN9_S.js";function oe(){const[E,k]=f.useState([]),[c,v]=f.useState(""),[u,b]=f.useState(null),[h,x]=f.useState(null);f.useEffect(()=>{g()},[]);async function g(){const{data:r,error:t}=await l.from("categories").select("*").order("name");if(t){x("Error al cargar categorías");return}k(r||[])}async function C(r){if(r.preventDefault(),x(null),!c.trim())return;const{error:t}=await l.from("categories").insert({name:c.trim()});if(t){x("Error al crear categoría");return}v(""),g()}async function A(r){const{error:t}=await l.from("categories").delete().eq("id",r);if(t){x("Error al eliminar categoría");return}g()}async function j(r,t){const{error:S}=await l.from("categories").update({name:t}).eq("id",r);if(S){x("Error al actualizar categoría");return}b(null),g()}return e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Gestionar Categorías"}),h&&e.jsx("div",{className:"mb-4 p-2 bg-red-100 text-red-700 rounded",children:h}),e.jsxs("form",{onSubmit:C,className:"mb-6 flex gap-2",children:[e.jsx("input",{type:"text",value:c,onChange:r=>v(r.target.value),placeholder:"Nueva categoría",className:"flex-1 p-2 border rounded focus:ring-2 focus:ring-orange-500"}),e.jsxs("button",{type:"submit",className:"bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"Agregar"]})]}),e.jsx("ul",{className:"space-y-2",children:E.map(r=>e.jsxs("li",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded",children:[u===r.id?e.jsx("input",{type:"text",defaultValue:r.name,onBlur:t=>j(r.id,t.target.value),onKeyDown:t=>{t.key==="Enter"&&j(r.id,t.currentTarget.value)},className:"flex-1 p-1 border rounded mr-2",autoFocus:!0}):e.jsx("span",{children:r.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>b(r.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Editar categoría",children:e.jsx(z,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>A(r.id),className:"text-red-600 hover:text-red-800","aria-label":"Eliminar categoría",children:e.jsx(B,{className:"h-5 w-5"})})]})]},r.id))})]})}function ce(){const[E,k]=f.useState([]),[c,v]=f.useState(""),[u,b]=f.useState(null),[h,x]=f.useState(null);f.useEffect(()=>{g()},[]);async function g(){const{data:r,error:t}=await l.from("anime").select("*").order("name");if(t){x("Error al cargar animes");return}k(r||[])}async function C(r){if(r.preventDefault(),x(null),!c.trim())return;const{error:t}=await l.from("anime").insert({name:c.trim()});if(t){x("Error al crear anime");return}v(""),g()}async function A(r){const{error:t}=await l.from("anime").delete().eq("id",r);if(t){x("Error al eliminar anime");return}g()}async function j(r,t){const{error:S}=await l.from("anime").update({name:t}).eq("id",r);if(S){x("Error al actualizar anime");return}b(null),g()}return e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Gestionar Animes"}),h&&e.jsx("div",{className:"mb-4 p-2 bg-red-100 text-red-700 rounded",children:h}),e.jsxs("form",{onSubmit:C,className:"mb-6 flex gap-2",children:[e.jsx("input",{type:"text",value:c,onChange:r=>v(r.target.value),placeholder:"Nuevo anime",className:"flex-1 p-2 border rounded focus:ring-2 focus:ring-orange-500"}),e.jsxs("button",{type:"submit",className:"bg-orange-500 text-white px-4 py-2 rounded hover:bg-orange-600 flex items-center gap-2",children:[e.jsx(L,{className:"h-5 w-5"}),"Agregar"]})]}),e.jsx("ul",{className:"space-y-2",children:E.map(r=>e.jsxs("li",{className:"flex items-center justify-between p-2 hover:bg-gray-50 rounded",children:[u===r.id?e.jsx("input",{type:"text",defaultValue:r.name,onBlur:t=>j(r.id,t.target.value),onKeyDown:t=>{t.key==="Enter"&&j(r.id,t.currentTarget.value)},className:"flex-1 p-1 border rounded mr-2",autoFocus:!0}):e.jsx("span",{children:r.name}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>b(r.id),className:"text-blue-600 hover:text-blue-800","aria-label":"Editar anime",children:e.jsx(z,{className:"h-5 w-5"})}),e.jsx("button",{onClick:()=>A(r.id),className:"text-red-600 hover:text-red-800","aria-label":"Eliminar anime",children:e.jsx(B,{className:"h-5 w-5"})})]})]},r.id))})]})}function xe(){const{session:E,loading:k}=ne(),[c,v]=n.useState(""),[u,b]=n.useState(1),[h,x]=n.useState(20),[g,C]=n.useState(0),[A,j]=n.useState(!1),[r,t]=n.useState(null),[S,G]=n.useState(()=>[]),[y,K]=n.useState([]),[O,$]=n.useState(!0),[R,V]=n.useState(()=>[]),[i,m]=n.useState(()=>({name:"",price:"",category_id:"",anime_id:"",description:"",images:[""],stock:0})),[P,F]=n.useState(null),[de,_]=n.useState(!1),[U,M]=n.useState([]),d=(a,s="Error desconocido")=>{a instanceof ie?t({message:a.message||s,details:a.details,code:a.code}):a instanceof Error?t({message:a.message||s,details:a.stack}):t({message:s}),console.error("Error detallado:",a)},T=async()=>{j(!0);try{let a=l.from("products").select("*",{count:"exact"});c.trim()&&(a=a.or(`name.ilike.%${c}%,description.ilike.%${c}%,category.ilike.%${c}%`));const{data:s,count:o,error:N}=await a.range((u-1)*h,u*h-1).order("created_at",{ascending:!1});if(N){d(N,"Error al cargar productos");return}G(s||[]),C(o||0)}catch(a){d(a,"Error inesperado al cargar productos")}finally{j(!1)}};if(n.useEffect(()=>{T()},[c,u]),k)return e.jsx("div",{children:"Loading..."});if(!E)return e.jsx("div",{children:"Unauthorized Access"});n.useEffect(()=>{W(),X()},[]),n.useEffect(()=>{y.length>0&&!i.category_id&&m(a=>({...a,category_id:y[0].id}))},[y]);const H=async()=>{const a=U.map(async s=>{const o=s.name.split(".").pop(),I=`product-images/${`${Date.now()}.${o}`}`,{error:w}=await l.storage.from("product-images").upload(I,s);if(w)throw d(w,"Error al subir imágenes"),w;const{data:{publicUrl:q}}=l.storage.from("product-images").getPublicUrl(I);return q});return Promise.all(a)},J=async a=>{if(a.preventDefault(),O){d(new Error("Cargando categorías, por favor espere"));return}if(y.length===0){d(new Error("No hay categorías disponibles. Cree una categoría primero."));return}_(!0),t(null);try{const s=i.category_id||y[0].id,o=y.find(p=>p.id===s);if(!o){d(new Error("Categoría inválida. Por favor seleccione una categoría válida.")),_(!1);return}const N=U.length>0?await H():i.images.filter(p=>p&&p.trim()!==""),I=N.length>0?N:["https://ik.imagekit.io/gatotaku/default-product-image.png"],w={name:i.name||null,description:i.description||null,price:parseFloat(i.price)||null,category_id:s||null,category:o.name,anime_id:i.anime_id||null,images:I,stock:Number(i.stock)||0},q=Object.entries(w).filter(([p,te])=>te===null&&p!=="anime_id"&&p!=="description").map(([p])=>p);if(q.length>0){d(new Error(`Campos requeridos faltantes: ${q.join(", ")}`)),_(!1);return}let D;try{if(P?D=await l.from("products").update(w).eq("id",P).select():D=await l.from("products").insert(w).select(),D.error){d(D.error,"Error al guardar el producto"),_(!1);return}Q(),T(),t(null)}catch(p){d(p,"Error inesperado al guardar el producto")}}catch(s){d(s,"Error de validación")}finally{_(!1)}},Q=()=>{var a;m({name:"",price:"",category_id:((a=y[0])==null?void 0:a.id)||"",anime_id:"",description:"",images:[""],stock:0}),F(null),M([])};async function W(){$(!0);const{data:a,error:s}=await l.from("categories").select("*").order("name");s?d(s,"Error al cargar categorías"):K(a||[]),$(!1)}async function X(){const{data:a,error:s}=await l.from("anime").select("*").order("name");s?d(s,"Error al cargar animes"):V(a||[])}async function Y(a){if(confirm("¿Estás seguro de que quieres eliminar este producto?"))try{const{error:s}=await l.from("products").delete().eq("id",a);s?d(s,"Error al eliminar el producto"):T()}catch(s){d(s,"Error al eliminar el producto")}}function Z(a){m({name:a.name,price:a.price.toString(),category_id:a.category_id||"",anime_id:a.anime_id||"",description:a.description,images:a.images,stock:a.stock||0}),F(a.id)}function ee(a,s){const o=[...i.images];o[a]=s,m({...i,images:o})}function ae(){m({...i,images:[...i.images,""]})}function re(a){const s=i.images.filter((o,N)=>N!==a);m({...i,images:s})}const se=()=>r?e.jsxs("div",{className:"error-details",children:[e.jsx("p",{className:"error-message",children:r.message}),r.details&&e.jsxs("details",{children:[e.jsx("summary",{children:"Detalles del error"}),e.jsx("pre",{children:r.details})]}),r.code&&e.jsxs("p",{children:["Código de error: ",r.code]})]}):null;return e.jsxs("div",{className:"admin-panel",children:[e.jsx(le,{title:"Panel de Administración",description:"Panel de administración de GATOTAKU"}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Panel de Administración"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8 mb-8",children:[e.jsx(oe,{}),e.jsx(ce,{})]}),r&&e.jsx("div",{className:"mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded",children:se()}),e.jsxs("form",{onSubmit:J,className:"bg-white p-6 rounded-lg shadow-md mb-8",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:P?"Editar Producto":"Nuevo Producto"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre"}),e.jsx("input",{type:"text",value:i.name,onChange:a=>m({...i,name:a.target.value}),className:"w-full p-2 border rounded",required:!0})]}),e.jsxs("div",{className:"mb-4 flex gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Precio"}),e.jsxs("div",{className:"mt-1 relative rounded-md shadow-sm",children:[e.jsx("div",{className:"absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none",children:e.jsx("span",{className:"text-gray-500 sm:text-sm",children:"C$"})}),e.jsx("input",{type:"number",name:"price",step:"0.01",value:i.price,onChange:a=>m({...i,price:a.target.value}),className:"mt-1 block w-full pl-8 pr-3 py-2 rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm"})]})]}),e.jsxs("div",{className:"w-32",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700",children:"Stock"}),e.jsx("input",{type:"number",name:"stock",value:i.stock,onChange:a=>m({...i,stock:parseInt(a.target.value)||0}),className:"mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-black focus:ring-black sm:text-sm",min:"0"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),e.jsxs("select",{value:i.category_id,onChange:a=>m({...i,category_id:a.target.value}),className:"w-full p-2 border rounded",required:!0,children:[e.jsx("option",{value:"",children:"Selecciona una categoría"}),y.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),e.jsxs("select",{value:i.anime_id,onChange:a=>m({...i,anime_id:a.target.value}),className:"w-full p-2 border rounded",required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un anime"}),R.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción"}),e.jsx("textarea",{value:i.description,onChange:a=>m({...i,description:a.target.value}),className:"w-full p-2 border rounded",rows:3,required:!0})]}),e.jsxs("div",{className:"mb-4",children:[i.images.map((a,s)=>e.jsxs("div",{className:"flex gap-2 mb-2",children:[e.jsx("input",{type:"url",value:a,onChange:o=>ee(s,o.target.value),className:"flex-1 p-2 border rounded",placeholder:"URL de la imagen",required:!0}),e.jsx("button",{type:"button",onClick:()=>re(s),className:"px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600","aria-label":"Eliminar imagen",children:e.jsx("i",{className:"fas fa-trash"})})]},s)),e.jsxs("button",{type:"button",onClick:ae,className:"mt-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:[e.jsx("i",{className:"fas fa-plus mr-2"}),"Agregar imagen"]})]}),e.jsxs("div",{className:"flex justify-end gap-2",children:[P&&e.jsx("button",{type:"button",onClick:()=>{m({name:"",price:"",category_id:"",anime_id:"",description:"",images:[""],stock:0}),F(null)},className:"px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600",children:"Cancelar"}),e.jsxs("button",{type:"submit",className:"px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600",children:[P?"Actualizar":"Crear"," Producto"]})]})]}),e.jsx("div",{className:"search-bar mb-4 flex items-center space-x-4",children:e.jsx("input",{type:"text",placeholder:"Buscar productos...",value:c,onChange:a=>{v(a.target.value),b(1)},className:"flex-grow p-2 border rounded-md"})}),e.jsx("div",{className:"bg-white rounded-lg shadow-md overflow-hidden",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200",children:[e.jsx("thead",{className:"bg-gray-50",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Producto"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Precio"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Categoría"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Anime"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Stock"}),e.jsx("th",{className:"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider",children:"Acciones"})]})}),e.jsx("tbody",{className:"bg-white divide-y divide-gray-200",children:S.map(a=>{var s,o;return e.jsxs("tr",{children:[e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:a.images[0],alt:a.name,className:"h-10 w-10 rounded-full object-cover"}),e.jsx("div",{className:"ml-4",children:e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a.name})})]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsxs("div",{className:"text-sm text-gray-900",children:["$",a.price.toFixed(2)]})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-orange-100 text-orange-800",children:(s=a.category_ref)==null?void 0:s.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("span",{className:"px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800",children:(o=a.anime)==null?void 0:o.name})}),e.jsx("td",{className:"px-6 py-4 whitespace-nowrap",children:e.jsx("div",{className:"text-sm text-gray-900",children:a.stock})}),e.jsxs("td",{className:"px-6 py-4 whitespace-nowrap text-sm font-medium",children:[e.jsx("button",{onClick:()=>Z(a),className:"text-indigo-600 hover:text-indigo-900 mr-4","aria-label":"Editar producto",children:e.jsx("i",{className:"fas fa-edit"})}),e.jsx("button",{onClick:()=>Y(a.id),className:"text-red-600 hover:text-red-900","aria-label":"Eliminar producto",children:e.jsx("i",{className:"fas fa-trash"})})]})]},a.id)})})]})}),e.jsxs("div",{className:"pagination flex justify-center items-center space-x-4 mt-4",children:[e.jsx("button",{onClick:()=>b(u-1),disabled:u===1,className:"px-4 py-2 bg-orange-500 text-white rounded-md disabled:opacity-50",children:"Anterior"}),e.jsxs("span",{className:"text-gray-700",children:["Página ",u," de ",Math.ceil(g/h)]}),e.jsx("button",{onClick:()=>b(u+1),disabled:u*h>=g,className:"px-4 py-2 bg-orange-500 text-white rounded-md disabled:opacity-50",children:"Siguiente"})]})]})]})}export{xe as default};
