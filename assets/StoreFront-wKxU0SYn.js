import{r as m,j as e,n as A,o as $,S as M,E as _,p as T,q as P}from"./vendor-DXgTlh3b.js";import{u as B,s as F,S as L,C as W}from"./index-C6R4gac7.js";function z({onFilterChange:r,currentFilters:h={},categories:y,animes:u,onResetFilters:p}){const[t,g]=m.useState(h),[f,C]=m.useState(!1),x=a=>{const c={...h,...a,page:1};g(c),r(c)},b=a=>{x({category:a.target.value===""?void 0:a.target.value})},j=a=>{x({anime:a.target.value===""?void 0:a.target.value})},v=a=>{const c=a.target.value?parseFloat(a.target.value):void 0;x({minPrice:c})},N=a=>{const c=a.target.value?parseFloat(a.target.value):void 0;x({maxPrice:c})},n=a=>{x({sortBy:a.target.value})},s=a=>{const c=a.target.value;g(i=>({...i,search:c===""?void 0:c})),r({search:c===""?void 0:c})},o=()=>{C(!f)},l=()=>{const a={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};g(a),r(a),p&&p()};return e.jsxs("div",{className:"search-and-filters-container",children:[e.jsxs("div",{className:"filter-group mb-4",children:[e.jsx("label",{htmlFor:"search-input-desktop",className:"block text-sm font-medium text-gray-700 my-2",children:"Buscar productos"}),e.jsx("input",{id:"search-input-desktop",type:"text",placeholder:"Buscar productos...",value:t.search||"",onChange:s,"aria-label":"Buscar productos por nombre o descripción",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 py-2 px-3"})]}),e.jsx("div",{className:"md:hidden flex justify-end mb-4",children:e.jsxs("button",{onClick:o,className:"flex items-center px-4 py-2 bg-orange-500 text-white rounded-md",children:[e.jsx(A,{className:"mr-2"})," Filtros"]})}),e.jsxs("div",{className:`
        additional-filters
        grid grid-cols-1 
        ${f?"grid":"hidden"} 
        md:grid md:grid-cols-2 md:gap-4
      `,children:[e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"category-select",className:"block text-sm font-medium text-gray-700 my-2",children:"Categoría"}),e.jsxs("select",{id:"category-select",value:t.category||"",onChange:b,"aria-label":"Seleccionar categoría de producto",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 py-2 px-3",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),y.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("div",{className:"filter-group flex-1 ",children:[e.jsx("label",{htmlFor:"anime-select",className:"block text-sm font-medium text-gray-700 my-2",children:"Anime"}),e.jsxs("select",{id:"anime-select",value:t.anime||"",onChange:j,"aria-label":"Seleccionar anime",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 py-2 px-3",children:[e.jsx("option",{value:"",children:"Todos los Animes"}),u.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]})]}),e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"min-price-input",className:"block text-sm font-medium text-gray-700 my-2",children:"Precio Mínimo"}),e.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:t.minPrice!==void 0?t.minPrice:"",onChange:v,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 py-2 px-3"})]}),e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"max-price-input",className:"block text-sm font-medium text-gray-700 my-2",children:"Precio Máximo"}),e.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:t.maxPrice!==void 0?t.maxPrice:"",onChange:N,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 py-2 px-3"})]})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("label",{htmlFor:"sort-select",className:"block text-sm font-medium text-gray-700 my-2",children:"Ordenar por"}),e.jsxs("select",{id:"sort-select",value:t.sortBy||"name_asc",onChange:n,"aria-label":"Ordenar productos",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500 py-2 px-3",children:[e.jsx("option",{value:"name_asc",children:"Nombre A-Z"}),e.jsx("option",{value:"name_desc",children:"Nombre Z-A"}),e.jsx("option",{value:"price_asc",children:"Precio: Menor a Mayor"}),e.jsx("option",{value:"price_desc",children:"Precio: Mayor a Menor"}),e.jsx("option",{value:"created_at",children:"Más Recientes"})]})]}),e.jsx("div",{className:"filter-group col-span-full",children:e.jsx("button",{onClick:l,className:"w-full my-2 px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300",children:"Restablecer Filtros"})})]})]})}function R({images:r,alt:h,srcSet:y,loading:u="lazy",className:p}){const t=m.useMemo(()=>Array.isArray(r)&&r.length>0?r.map((n,s)=>typeof n=="string"?{src:n,srcSet:`${n}?tr=w-320,h-320 320w, ${n}?tr=w-640,h-640 640w, ${n}?tr=w-1024,h-1024 1024w, ${n}?tr=w-1920,h-1920 1920w`}:n.srcSet?n:{...n,srcSet:`${n.src}?tr=w-320,h-320 320w, ${n.src}?tr=w-640,h-640 640w, ${n.src}?tr=w-1024,h-1024 1024w, ${n.src}?tr=w-1920,h-1920 1920w`}):[{src:"https://via.placeholder.com/400x400?text=No+Image",srcSet:"https://via.placeholder.com/400x400?text=No+Image 320w"}],[r]),[g,f]=m.useState(0),[C,x]=m.useState([]),b=m.useRef(null);m.useEffect(()=>{f(0),x([])},[t]),m.useEffect(()=>{const n=(g+1)%t.length,s=t[n];b.current&&(b.current.src=s.src,b.current.srcset=s.srcSet||"")},[g,t]);const j=m.useCallback(()=>{f(n=>n===t.length-1?0:n+1)},[t]),v=m.useCallback(()=>{f(n=>n===0?t.length-1:n-1)},[t]),N=m.useCallback(n=>{x(s=>[...s,n])},[t]);return e.jsxs("div",{className:`${p} relative w-full h-full overflow-hidden`,onClick:n=>n.stopPropagation(),children:[e.jsxs("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:[t.map((n,s)=>{const o=s===g,l=C.includes(s);return e.jsx("div",{className:`
                absolute inset-0 transition-all duration-500 ease-in-out
                ${o?"opacity-100 z-10 visible":"opacity-0 z-0 invisible"}
                ${l?"hidden":""}
              `,children:e.jsx("img",{src:n.src,alt:`${h} - Image ${s+1}`,srcSet:n.srcSet,loading:u,onError:()=>N(s),className:"w-full h-full object-cover"},`img-${s}`)},`${n.src}-${s}`)}),e.jsx("img",{ref:b,style:{display:"none"},alt:"Preloaded image"})]}),t.length>1&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:v,className:"absolute left-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-orange-500 transition-colors z-20","aria-label":"Previous Image",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M15 19l-7-7 7-7"})})}),e.jsx("button",{onClick:j,className:"absolute right-2 top-1/2 -translate-y-1/2 bg-black/50 text-white p-2 rounded-full hover:bg-orange-500 transition-colors z-20","aria-label":"Next Image",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 5l7 7-7 7"})})})]}),t.length>1&&e.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2 z-20",children:t.map((n,s)=>e.jsx("button",{onClick:()=>f(s),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${s===g?"bg-orange-500":"bg-gray-300"}
              `,"aria-label":`Go to image ${s+1}`},`dot-${s}`))})]})}function O(r){return(Array.isArray(r)?r:[r]).filter(u=>u&&u.trim()!=="").map(u=>{try{return[{descriptor:"320w",width:320},{descriptor:"640w",width:640},{descriptor:"1024w",width:1024},{descriptor:"1920w",width:1920}].map(t=>`${u} ${t.descriptor}`).join(", ")}catch(p){return console.error("Error generating WebP srcset:",p),u}})}function V({product:r,className:h}){const{addItem:y}=B(),u=$.useMemo(()=>{if(!r.images||r.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const t=r.images.filter(g=>g&&g.trim()!=="");return t.length>0?t:["https://via.placeholder.com/400x400?text=No+Image"]},[r.images]),p=$.useMemo(()=>O(u),[u]);return e.jsxs("div",{className:[h,"product-card border rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col h-full"].filter(Boolean).join(" "),children:[e.jsx("div",{className:"w-full aspect-square bg-[#c8cdcc]",children:e.jsx("div",{className:"w-full h-full object-cover",children:e.jsx(R,{images:u,alt:r.name,srcSet:p.join(", "),loading:"lazy"})})}),e.jsxs("div",{className:"bg-white/90 py-3 px-4 flex-grow flex flex-col justify-between border-t border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-1",children:r.name}),e.jsxs("div",{className:"flex gap-1 text-xs text-orange-500 mb-1",children:[r.category_ref&&e.jsx("span",{children:r.category_ref.name}),r.anime&&e.jsxs("span",{children:["• ",r.anime.name]})]}),e.jsxs("span",{className:"text-lg font-bold text-orange-500 block mb-1",children:["C$",r.price.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-2",children:r.description})]}),e.jsxs("button",{onClick:()=>y(r),className:"w-full bg-black text-white py-2 px-2 rounded-md hover:bg-gray-900 transition-colors flex items-center justify-center gap-1","aria-label":`Agregar ${r.name} al carrito`,children:[e.jsx(M,{size:16}),"Agregar"]})]})]})}function q({error:r,resetErrorBoundary:h}){return m.useEffect(()=>{console.error("StoreFront Component Error:",r)},[r]),e.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),e.jsx("p",{className:"text-red-500",children:r.message}),e.jsx("button",{onClick:h,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function U(){return e.jsx(_,{FallbackComponent:q,onReset:()=>{window.history.go(0)},children:e.jsx("main",{className:"store-front",children:e.jsx(H,{})})})}function H(){var n;const[r,h]=m.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1}));m.useEffect(()=>{const s=()=>{h({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",s),()=>{window.removeEventListener("reset-store-filters",s)}},[]);const y=m.useCallback(async()=>{var c,i;const[s,o]=await Promise.all([F.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),F.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),l=((c=s.data)==null?void 0:c.filter(d=>d.products.length>0).map(d=>({id:d.id,name:d.name})))||[],a=((i=o.data)==null?void 0:i.filter(d=>d.products.length>0).map(d=>({id:d.id,name:d.name})))||[];return{categoriesWithProducts:l,animesWithProducts:a}},[]),u=async s=>{try{const o=s.trim().toLowerCase(),l=[];l.push(`name.ilike.%${o}%`),l.push(`description.ilike.%${o}%`),l.push(`category.ilike.%${o}%`);const{data:a}=await F.from("anime").select("id").ilike("name",`%${o}%`).limit(1);return a&&a.length>0&&l.push(`anime_id.eq.${a[0].id}`),l.length>0?l.join(","):""}catch(o){return console.error("Error en búsqueda flexible:",o),""}},p=m.useCallback(async({pageParam:s=1})=>{try{const l=window.innerWidth<768?6:12,a=(s-1)*l,c=a+l-1;let i=F.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(r.search&&r.search.trim()!==""){const I=r.search.toLowerCase().trim();try{const k=await u(I);k&&(i=i.or(k))}catch(k){console.error("Error en búsqueda de productos:",k)}}r.category&&r.category.trim()!==""&&(i=i.eq("category_id",r.category)),r.anime&&r.anime.trim()!==""&&(i=i.eq("anime_id",r.anime)),r.minPrice!==void 0&&(i=i.gte("price",r.minPrice)),r.maxPrice!==void 0&&(i=i.lte("price",r.maxPrice)),i=i.order(r.sortBy.split("_")[0],{ascending:r.sortBy.endsWith("_asc")});const{data:d,error:w,count:S}=await i.range(a,c);if(w)throw w;const E=S?Math.ceil(S/l):0;return{products:d||[],totalPages:E}}catch(o){return console.error("🚨 Error en búsqueda de productos:",o),{products:[],totalPages:0}}},[r]),{data:t,isLoading:g,error:f,isError:C,refetch:x}=T({queryKey:["products",r],queryFn:async()=>{const{categoriesWithProducts:s,animesWithProducts:o}=await y(),l=await p({pageParam:r.page||1});return{categoriesWithProducts:s,animesWithProducts:o,...l}},placeholderData:s=>s,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),b=m.useCallback(s=>{h(o=>({...o,...s}))},[]),j=s=>{h(o=>({...o,page:s}))},v=()=>{h({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})},N=()=>{const s=(t==null?void 0:t.totalPages)||0,o=r.page||1;if(s<=1)return null;const l=()=>{let d=1,w=s;return s>5&&(o<=3?(d=1,w=5):o>=s-2?(d=s-5+1,w=s):(d=o-2,w=o+2)),{startPage:d,endPage:w}},{startPage:a,endPage:c}=l();return e.jsxs("div",{className:"flex justify-center items-center mt-8 space-x-4 w-full px-4",children:[e.jsx(P.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>j(o-1),disabled:o===1,className:"px-4 py-2 rounded-md bg-gray-200 disabled:opacity-50",children:"←"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[a>1&&e.jsx(P.span,{initial:{opacity:0},animate:{opacity:1},className:"text-gray-500",children:"..."}),Array.from({length:c-a+1},(i,d)=>a+d).map(i=>e.jsx(P.button,{whileHover:{scale:1.05},whileTap:{scale:.95},onClick:()=>j(i),animate:{scale:o===i?1.2:1},className:`
                pagination-btn
                ${o===i?"pagination-btn-active":"pagination-btn-inactive"}
              `,transition:{type:"spring",stiffness:300,damping:20},children:i},i)),c<s&&e.jsx(P.span,{initial:{opacity:0},animate:{opacity:1},className:"text-gray-500",children:"..."})]}),e.jsx(P.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:()=>j(o+1),disabled:o===s,className:"px-4 py-2 rounded-md bg-gray-200 disabled:opacity-50",children:"→"})]})};return e.jsxs("div",{className:"relative min-h-screen bg-white overflow-hidden",children:[e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10",children:[e.jsx(L,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, mangas, accesorios y más."}),e.jsx("div",{className:"mb-8 bg-gray-50 rounded-lg shadow-md p-6",children:g?e.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):e.jsx(z,{onFilterChange:b,currentFilters:r,categories:(t==null?void 0:t.categoriesWithProducts)||[],animes:(t==null?void 0:t.animesWithProducts)||[],onResetFilters:v})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4",children:(n=t==null?void 0:t.products)==null?void 0:n.map(s=>e.jsx(V,{product:s},s.id))}),N()]}),e.jsx(W,{})]})}export{U as default};
