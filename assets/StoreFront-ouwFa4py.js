import{r as i,j as t,t as R,R as E,S as A,E as T,v as z}from"./vendor-BL6wRtct.js";import{u as D,s as F,S as M}from"./index-Cq0W3FBt.js";function O({onFilterChange:a,currentFilters:u={},categories:w,animes:y,onResetFilters:b}){const[n,x]=i.useState(u),[o,f]=i.useState(!1),h=r=>{const e={...u,...r,page:1};x(e),a(e)},j=r=>{h({category:r.target.value===""?void 0:r.target.value})},p=r=>{h({anime:r.target.value===""?void 0:r.target.value})},c=r=>{const e=r.target.value?parseFloat(r.target.value):void 0;h({minPrice:e})},v=r=>{const e=r.target.value?parseFloat(r.target.value):void 0;h({maxPrice:e})},N=r=>{const e=r.target.value;x(s=>({...s,search:e===""?void 0:e})),a({search:e===""?void 0:e})},C=()=>{f(!o)},P=()=>{const r={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};x(r),a(r),b&&b()};return t.jsxs("div",{className:"search-and-filters-container pt-4",children:[t.jsx("div",{className:"filter-group mb-4",children:t.jsx("input",{id:"search-input-desktop",type:"text",placeholder:"Buscar productos...",value:n.search||"",onChange:N,"aria-label":"Buscar productos por nombre o descripción",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})}),t.jsx("div",{className:"md:hidden flex justify-end mb-4",children:t.jsxs("button",{onClick:C,className:"flex items-center px-4 py-2 bg-orange-500 text-white rounded-md",children:[t.jsx(R,{className:"mr-2"})," Filtros"]})}),t.jsxs("div",{className:`
        additional-filters
        grid grid-cols-1 
        ${o?"grid":"hidden"} 
        md:grid md:grid-cols-2 md:gap-4
      `,children:[t.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[t.jsxs("div",{className:"filter-group flex-1",children:[t.jsx("label",{htmlFor:"category-select",className:" my-2 block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),t.jsxs("select",{id:"category-select",value:n.category||"",onChange:j,"aria-label":"Seleccionar categoría de producto",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[t.jsx("option",{value:"",children:"Todas las categorías"}),w.sort((r,e)=>r.name.localeCompare(e.name)).map(r=>t.jsx("option",{value:r.id,children:r.name},r.id))]})]}),t.jsxs("div",{className:"filter-group flex-1 ",children:[t.jsx("label",{htmlFor:"anime-select",className:" my-2 block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),t.jsxs("select",{id:"anime-select",value:n.anime||"",onChange:p,"aria-label":"Seleccionar anime",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[t.jsx("option",{value:"",children:"Todos los Animes"}),y.sort((r,e)=>r.name.localeCompare(e.name)).map(r=>t.jsx("option",{value:r.id,children:r.name},r.id))]})]})]}),t.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2 my-4",children:[t.jsx("div",{className:"filter-group flex-1",children:t.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:n.minPrice!==void 0?n.minPrice:"",onChange:c,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})}),t.jsx("div",{className:"filter-group flex-1",children:t.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:n.maxPrice!==void 0?n.maxPrice:"",onChange:v,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})})]}),t.jsx("div",{className:"filter-group col-span-full",children:t.jsx("button",{onClick:P,className:"w-full px-4 py-2 mt-4 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300",children:"Restablecer Filtros"})})]})]})}function W({images:a,alt:u,srcSet:w,loading:y="lazy",className:b="",imageRefs:n,onFullyLoaded:x}){const o=E.useMemo(()=>!a||a.length===0?["https://via.placeholder.com/400x400?text=No+Image"]:a,[a]),[f,h]=i.useState(0),[j,p]=i.useState([]),c=i.useRef([]);i.useEffect(()=>{h(0)},[o]),i.useEffect(()=>{o.forEach(e=>{const s=new Image;s.src=typeof e=="string"?e:e.src})},[o]);const v=e=>{p(s=>s.includes(e)?s:[...s,e])},N=e=>{x&&x()},C=e=>{h(e)},P=()=>{h(e=>e===0?o.length-1:e-1)},r=()=>{h(e=>(e+1)%o.length)};return i.useEffect(()=>{n&&n(c.current)},[o,n]),t.jsxs("div",{className:`${b} relative w-full h-full overflow-hidden`,onClick:e=>e.stopPropagation(),children:[o.length>1&&t.jsx("button",{onClick:P,className:"absolute left-2 top-1/2 transform -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center",children:t.jsx("div",{className:"bg-orange-500/50 hover:bg-orange-600/60 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-all duration-300",children:t.jsx("span",{className:"text-white text-xl font-bold transform -translate-x-0.5",children:"‹"})})}),o.length>1&&t.jsx("button",{onClick:r,className:"absolute right-2 top-1/2 transform -translate-y-1/2 z-20 w-10 h-10 flex items-center justify-center",children:t.jsx("div",{className:"bg-orange-500/50 hover:bg-orange-600/60 rounded-full w-8 h-8 flex items-center justify-center shadow-lg transition-all duration-300",children:t.jsx("span",{className:"text-white text-xl font-bold transform translate-x-0.5",children:"›"})})}),o.length>1&&t.jsxs("div",{className:"absolute bottom-2 right-2 z-20 bg-black/50 text-white px-2 py-1 rounded-full text-xs",children:[f+1," / ",o.length]}),t.jsx("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:o.map((e,s)=>{const m=typeof e=="string"?e:e.src,g=s===f,l=j.includes(s);return t.jsx("div",{className:`
                absolute inset-0 transition-opacity duration-300
                ${g?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}
              `,children:t.jsxs("picture",{children:[typeof e=="object"&&e.webp&&t.jsx("source",{srcSet:e.webp,type:"image/webp"}),t.jsx("img",{ref:d=>c.current[s]=d,src:l?"https://via.placeholder.com/400x400?text=Image+Error":m,alt:`${u} - imagen ${s+1}`,srcSet:typeof e=="object"?e.srcSet:void 0,loading:y,onError:()=>v(s),onLoad:()=>N(),className:"w-full h-full object-cover absolute inset-0 transform scale-100"})]})},`${m}-${s}`)})}),o.length>1&&t.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2",children:o.map((e,s)=>t.jsx("button",{onClick:()=>C(s),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${s===f?"bg-orange-500":"bg-gray-300"}
              `},s))})]})}function B(a){const u=[400,800,1200];return a.map(w=>u.map(y=>`${w} ${y}w`).join(", "))}function _(a){return a.toLowerCase().endsWith(".webp"),a}function V(a){return`data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg' viewBox%3D'0 0 1 1'%3E%3Cfilter id%3D'blur' filterUnits%3D'userSpaceOnUse' color-interpolation-filters%3D'sRGB'%3E%3CfeGaussianBlur stdDeviation%3D'10'%2F%3E%3C%2Ffilter%3E%3Cimage x%3D'0' y%3D'0' width%3D'100%25' height%3D'100%25' preserveAspectRatio%3D'none' href%3D'${a}' filter%3D'url(%23blur)'%2F%3E%3C%2Fsvg%3E`}function G({product:a,className:u}){const{addItem:w}=D(),[y,b]=i.useState(0),[n,x]=i.useState(!1),o=i.useRef(null),f=i.useRef(null),h=E.useMemo(()=>{if(!a.images||a.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const c=a.images.filter(v=>v&&v.trim()!=="");return c.length>0?c:["https://via.placeholder.com/400x400?text=No+Image"]},[a.images]),j=E.useMemo(()=>h.map((c,v)=>({src:c,srcSet:B([c])[0],webp:_(c),lowResSrc:V(c)})),[h]),p=i.useCallback(()=>{o.current&&clearInterval(o.current),f.current&&clearTimeout(f.current),b(100),x(!0)},[]);return i.useEffect(()=>(b(0),x(!1),o.current=setInterval(()=>{b(c=>c<80?c+10:(clearInterval(o.current),c))},200),f.current=setTimeout(()=>{p()},5e3),()=>{o.current&&clearInterval(o.current),f.current&&clearTimeout(f.current)}),[a,p]),t.jsxs("div",{className:[u,"product-card bg-white border border-gray-200 rounded-xl overflow-hidden shadow-lg hover:shadow-xl flex flex-col h-full relative transition-all duration-300 hover:scale-[1.02] hover:-translate-y-1"].filter(Boolean).join(" "),children:[t.jsxs("div",{className:"w-full aspect-square overflow-hidden relative bg-gray-100",children:[t.jsx("div",{className:"absolute top-0 left-0 h-1 bg-orange-500 z-50 transition-all duration-300",style:{width:`${y}%`,opacity:n?0:1}}),t.jsx("div",{className:"absolute inset-0 bg-cover bg-center opacity-50 blur-lg transition-opacity duration-300",style:{backgroundImage:`url(${j[0].lowResSrc})`,zIndex:10,opacity:n?0:.5}}),t.jsx(W,{images:j,alt:a.name,loading:"lazy",className:"w-full h-full relative z-20 transition-opacity duration-500",onFullyLoaded:p})]}),t.jsxs("div",{className:"bg-white p-4 flex-grow flex flex-col justify-between",children:[t.jsxs("div",{children:[t.jsx("h2",{className:"text-base font-bold text-gray-900 mb-2 line-clamp-2",children:a.name}),t.jsxs("div",{className:"flex flex-wrap gap-1 text-xs mb-2",children:[a.category_ref&&t.jsx("span",{className:"bg-orange-100 text-orange-700 px-2 py-1 rounded-full",children:a.category_ref.name}),a.anime&&t.jsx("span",{className:"bg-blue-100 text-blue-700 px-2 py-1 rounded-full",children:a.anime.name})]}),t.jsxs("span",{className:"text-xl font-bold text-orange-600 block mb-2",children:["C$",a.price.toFixed(2)]}),t.jsx("p",{className:"text-xs text-gray-600 mb-3 line-clamp-2",children:a.description})]}),t.jsxs("button",{onClick:()=>w(a),className:"w-full bg-orange-500 text-white py-2 px-3 rounded-md flex items-center justify-center gap-1 hover:bg-orange-600 transition-all duration-200 font-medium text-sm shadow-sm hover:shadow-md","aria-label":`Agregar ${a.name} al carrito`,children:[t.jsx(A,{size:14}),"Agregar"]})]})]})}function U({error:a,resetErrorBoundary:u}){return i.useEffect(()=>{},[a]),t.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[t.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),t.jsx("p",{className:"text-red-500",children:a.message}),t.jsx("button",{onClick:u,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function Q(){return t.jsx(T,{FallbackComponent:U,onReset:()=>{window.history.go(0)},children:t.jsx("main",{className:"store-front",children:t.jsx(H,{})})})}function H(){var P;const[a,u]=i.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1}));i.useEffect(()=>{const r=()=>{u({search:"",category:"",anime:"",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",r),()=>{window.removeEventListener("reset-store-filters",r)}},[]);const w=i.useCallback(async()=>{var g,l;const[r,e]=await Promise.all([F.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),F.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),s=((g=r.data)==null?void 0:g.filter(d=>d.products.length>0).map(d=>({id:d.id,name:d.name})))||[],m=((l=e.data)==null?void 0:l.filter(d=>d.products.length>0).map(d=>({id:d.id,name:d.name})))||[];return{categoriesWithProducts:s,animesWithProducts:m}},[]),y=async r=>{try{const e=r.trim().toLowerCase(),s=[];s.push(`name.ilike.%${e}%`),s.push(`description.ilike.%${e}%`),s.push(`category.ilike.%${e}%`);const{data:m}=await F.from("anime").select("id").ilike("name",`%${e}%`).limit(1);return m&&m.length>0&&s.push(`anime_id.eq.${m[0].id}`),s.length>0?s.join(","):""}catch{return""}},b=i.useCallback(async({pageParam:r=1})=>{try{const s=window.innerWidth<768?6:12,m=(r-1)*s,g=m+s-1;let l=F.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(a.search&&a.search.trim()!==""){const $=a.search.toLowerCase().trim();try{const k=await y($);k&&(l=l.or(k))}catch{}}a.category&&a.category.trim()!==""&&(l=l.eq("category_id",a.category)),a.anime&&a.anime.trim()!==""&&(l=l.eq("anime_id",a.anime)),a.minPrice!==void 0&&(l=l.gte("price",a.minPrice)),a.maxPrice!==void 0&&(l=l.lte("price",a.maxPrice));const{data:d,error:I,count:S}=await l.range(m,g);if(I)throw I;const L=S?Math.ceil(S/s):0;return{products:d||[],totalPages:L}}catch{return{products:[],totalPages:0}}},[a]),{data:n,isLoading:x,error:o,isError:f,refetch:h}=z({queryKey:["products",a],queryFn:async()=>{const{categoriesWithProducts:r,animesWithProducts:e}=await w(),s=await b({pageParam:a.page||1});return{categoriesWithProducts:r,animesWithProducts:e,...s}},placeholderData:r=>r,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),j=i.useCallback(r=>{u(e=>({...e,...r}))},[]),p=r=>{u(e=>({...e,page:r}))},c=()=>{u({search:"",category:"",anime:"",minPrice:void 0,maxPrice:void 0,page:1})},[v,N]=i.useState(0);i.useEffect(()=>{let r=!1;const e=()=>{r||(requestAnimationFrame(()=>{const s=document.querySelector("footer"),m=window.innerHeight;if(s){const g=s.getBoundingClientRect();if(g.top<m){const l=m-g.top;N(l)}else N(0)}r=!1}),r=!0)};return e(),window.addEventListener("scroll",e,{passive:!0}),window.addEventListener("resize",e),()=>{window.removeEventListener("scroll",e),window.removeEventListener("resize",e)}},[]);const C=()=>{const r=(n==null?void 0:n.totalPages)||0,e=a.page||1;if(r<=1)return null;const m=e<=3?Array.from({length:Math.min(5,r)},(l,d)=>d+1):e>=r-2?Array.from({length:5},(l,d)=>r-5+d+1):[e-2,e-1,e,e+1,e+2];return t.jsx("div",{className:"fixed bottom-0 left-0 right-0 flex justify-center items-center py-2 z-50 bg-white/95 backdrop-blur-sm transition-transform duration-200 ease-out shadow-lg border-t border-gray-200",style:{transform:`translateY(-${v}px)`},children:t.jsxs("div",{className:"flex items-center space-x-1 sm:space-x-2",children:[t.jsxs("span",{className:"hidden md:block text-xs text-gray-500 mr-2",children:[e,"/",r]}),t.jsx("button",{onClick:()=>p(e-1),disabled:e===1,className:"w-8 h-8 sm:w-9 sm:h-9 rounded-md bg-gray-100 hover:bg-orange-100 disabled:opacity-50 transition-colors flex items-center justify-center text-sm",children:"←"}),m.map(g=>t.jsx("button",{onClick:()=>p(g),className:`w-8 h-8 sm:w-9 sm:h-9 rounded-md transition-colors flex items-center justify-center text-sm font-medium ${e===g?"bg-orange-500 text-white shadow-sm":"bg-gray-100 hover:bg-orange-100 text-gray-700"}`,children:g},g)),t.jsx("button",{onClick:()=>p(e+1),disabled:e===r,className:"w-8 h-8 sm:w-9 sm:h-9 rounded-md bg-gray-100 hover:bg-orange-100 disabled:opacity-50 transition-colors flex items-center justify-center text-sm",children:"→"})]})})};return t.jsx("div",{className:"relative min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 overflow-hidden",children:t.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10",children:[t.jsx(M,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, accesorios y más."}),t.jsx("div",{className:"mb-6 bg-white rounded-xl shadow-lg p-4 border border-gray-200",children:x?t.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):t.jsx(O,{onFilterChange:j,currentFilters:a,categories:(n==null?void 0:n.categoriesWithProducts)||[],animes:(n==null?void 0:n.animesWithProducts)||[],onResetFilters:c})}),t.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-3 sm:gap-4 md:gap-6",children:(P=n==null?void 0:n.products)==null?void 0:P.map((r,e)=>t.jsx("div",{className:"transition-all duration-300",style:{transitionDelay:`${e*50}ms`,willChange:"transform, opacity"},children:t.jsx(G,{product:r})},r.id))}),C()]})})}export{Q as default};
