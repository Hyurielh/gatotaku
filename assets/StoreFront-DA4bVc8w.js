import{r as d,j as e,n as $,o as E,S as A,E as M,p as _}from"./vendor-CfrxxlCL.js";import{u as L,s as k,S as R}from"./index-D3iOCjlC.js";function T({onFilterChange:t,currentFilters:g={},categories:v,animes:y,onResetFilters:b}){const[o,f]=d.useState(g),[l,x]=d.useState(!1),h=r=>{const a={...g,...r,page:1};f(a),t(a)},N=r=>{h({category:r.target.value===""?void 0:r.target.value})},p=r=>{h({anime:r.target.value===""?void 0:r.target.value})},m=r=>{const a=r.target.value?parseFloat(r.target.value):void 0;h({minPrice:a})},j=r=>{const a=r.target.value?parseFloat(r.target.value):void 0;h({maxPrice:a})},w=r=>{h({sortBy:r.target.value})},n=r=>{const a=r.target.value;f(i=>({...i,search:a===""?void 0:a})),t({search:a===""?void 0:a})},s=()=>{x(!l)},c=()=>{const r={search:void 0,category:void 0,anime:void 0,minPrice:void 0,maxPrice:void 0,sortBy:"name_asc"};f(r),t(r),b&&b()};return e.jsxs("div",{className:"search-and-filters-container",children:[e.jsxs("div",{className:"filter-group mb-4",children:[e.jsx("label",{htmlFor:"search-input-desktop",className:"block text-sm font-medium text-gray-700 mb-1",children:"Buscar productos"}),e.jsx("input",{id:"search-input-desktop",type:"text",placeholder:"Buscar productos...",value:o.search||"",onChange:n,"aria-label":"Buscar productos por nombre o descripción",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsx("div",{className:"md:hidden flex justify-end mb-4",children:e.jsxs("button",{onClick:s,className:"flex items-center px-4 py-2 bg-orange-500 text-white rounded-md",children:[e.jsx($,{className:"mr-2"})," Filtros"]})}),e.jsxs("div",{className:`
        additional-filters
        grid grid-cols-1 
        ${l?"grid":"hidden"} 
        md:grid md:grid-cols-2 md:gap-4
      `,children:[e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"category-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Categoría"}),e.jsxs("select",{id:"category-select",value:o.category||"",onChange:N,"aria-label":"Seleccionar categoría de producto",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),v.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]}),e.jsxs("div",{className:"filter-group flex-1 ",children:[e.jsx("label",{htmlFor:"anime-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Anime"}),e.jsxs("select",{id:"anime-select",value:o.anime||"",onChange:p,"aria-label":"Seleccionar anime",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"",children:"Todos los Animes"}),y.map(r=>e.jsx("option",{value:r.id,children:r.name},r.id))]})]})]}),e.jsxs("div",{className:"md:flex md:space-x-4 md:col-span-2",children:[e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"min-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Mínimo"}),e.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:o.minPrice!==void 0?o.minPrice:"",onChange:m,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]}),e.jsxs("div",{className:"filter-group flex-1",children:[e.jsx("label",{htmlFor:"max-price-input",className:"block text-sm font-medium text-gray-700 mb-1",children:"Precio Máximo"}),e.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:o.maxPrice!==void 0?o.maxPrice:"",onChange:j,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500"})]})]}),e.jsxs("div",{className:"col-span-full",children:[e.jsx("label",{htmlFor:"sort-select",className:"block text-sm font-medium text-gray-700 mb-1",children:"Ordenar por"}),e.jsxs("select",{id:"sort-select",value:o.sortBy||"name_asc",onChange:w,"aria-label":"Ordenar productos",className:"block w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500",children:[e.jsx("option",{value:"name_asc",children:"Nombre A-Z"}),e.jsx("option",{value:"name_desc",children:"Nombre Z-A"}),e.jsx("option",{value:"price_asc",children:"Precio: Menor a Mayor"}),e.jsx("option",{value:"price_desc",children:"Precio: Mayor a Menor"}),e.jsx("option",{value:"created_at",children:"Más Recientes"})]})]}),e.jsx("div",{className:"filter-group col-span-full",children:e.jsx("button",{onClick:c,className:"w-full px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300",children:"Restablecer Filtros"})})]})]})}function B({images:t,alt:g,srcSet:v,loading:y="lazy",className:b="",imageRefs:o,onFullyLoaded:f}){const l=E.useMemo(()=>!t||t.length===0?["https://via.placeholder.com/400x400?text=No+Image"]:t,[t]),[x,h]=d.useState(0),[N,p]=d.useState([]),m=d.useRef([]);d.useEffect(()=>{h(0)},[l]),d.useEffect(()=>{l.forEach(r=>{const a=new Image;a.src=typeof r=="string"?r:r.src})},[l]);const j=r=>{p(a=>a.includes(r)?a:[...a,r])},w=r=>{f&&f()},n=r=>{h(r)},s=()=>{h(r=>r===0?l.length-1:r-1)},c=()=>{h(r=>(r+1)%l.length)};return d.useEffect(()=>{o&&o(m.current)},[l,o]),e.jsxs("div",{className:`${b} relative w-full h-full overflow-hidden`,onClick:r=>r.stopPropagation(),children:[l.length>1&&e.jsx("button",{onClick:s,className:"absolute left-0 top-1/2 transform -translate-y-1/2 z-20 w-16 h-16 flex items-center justify-center",children:e.jsx("div",{className:"bg-orange-500/70 hover:bg-orange-600/80 rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all duration-300",children:e.jsx("span",{className:"text-white text-3xl font-bold transform -translate-x-0.5",children:"‹"})})}),l.length>1&&e.jsx("button",{onClick:c,className:"absolute right-0 top-1/2 transform -translate-y-1/2 z-20 w-16 h-16 flex items-center justify-center",children:e.jsx("div",{className:"bg-orange-500/70 hover:bg-orange-600/80 rounded-full w-12 h-12 flex items-center justify-center shadow-lg transition-all duration-300",children:e.jsx("span",{className:"text-white text-3xl font-bold transform translate-x-0.5",children:"›"})})}),e.jsx("div",{className:"absolute inset-0 grid grid-cols-1 grid-rows-1",children:l.map((r,a)=>{const i=typeof r=="string"?r:r.src,u=a===x,P=N.includes(a);return e.jsx("div",{className:`
                absolute inset-0 transition-opacity duration-300
                ${u?"opacity-100 pointer-events-auto":"opacity-0 pointer-events-none"}
              `,children:e.jsxs("picture",{children:[typeof r=="object"&&r.webp&&e.jsx("source",{srcSet:r.webp,type:"image/webp"}),e.jsx("img",{ref:C=>m.current[a]=C,src:P?"https://via.placeholder.com/400x400?text=Image+Error":i,alt:`${g} - imagen ${a+1}`,srcSet:typeof r=="object"?r.srcSet:void 0,loading:y,onError:()=>j(a),onLoad:()=>w(),className:"w-full h-full object-cover absolute inset-0 transform scale-100"})]})},`${i}-${a}`)})}),l.length>1&&e.jsx("div",{className:"absolute bottom-2 left-1/2 transform -translate-x-1/2 flex space-x-2",children:l.map((r,a)=>e.jsx("button",{onClick:()=>n(a),className:`
                w-2 h-2 rounded-full transition-colors duration-300
                ${a===x?"bg-orange-500":"bg-gray-300"}
              `},a))})]})}function D(t){const g=[400,800,1200];return t.map(v=>g.map(y=>`${v} ${y}w`).join(", "))}function W(t){return t.toLowerCase().endsWith(".webp"),t}function z(t){return`data:image/svg+xml;charset=utf-8,%3Csvg xmlns%3D'http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg' viewBox%3D'0 0 1 1'%3E%3Cfilter id%3D'blur' filterUnits%3D'userSpaceOnUse' color-interpolation-filters%3D'sRGB'%3E%3CfeGaussianBlur stdDeviation%3D'10'%2F%3E%3C%2Ffilter%3E%3Cimage x%3D'0' y%3D'0' width%3D'100%25' height%3D'100%25' preserveAspectRatio%3D'none' href%3D'${t}' filter%3D'url(%23blur)'%2F%3E%3C%2Fsvg%3E`}function O({product:t,className:g}){const{addItem:v}=L(),[y,b]=d.useState(0),[o,f]=d.useState(!1),l=d.useRef(null),x=d.useRef(null),h=E.useMemo(()=>{if(!t.images||t.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const m=t.images.filter(j=>j&&j.trim()!=="");return m.length>0?m:["https://via.placeholder.com/400x400?text=No+Image"]},[t.images]),N=E.useMemo(()=>h.map((m,j)=>({src:m,srcSet:D([m])[0],webp:W(m),lowResSrc:z(m)})),[h]),p=d.useCallback(()=>{l.current&&clearInterval(l.current),x.current&&clearTimeout(x.current),b(100),f(!0)},[]);return d.useEffect(()=>(b(0),f(!1),l.current=setInterval(()=>{b(m=>m<80?m+10:(clearInterval(l.current),m))},200),x.current=setTimeout(()=>{p()},5e3),()=>{l.current&&clearInterval(l.current),x.current&&clearTimeout(x.current)}),[t,p]),e.jsxs("div",{className:[g,"product-card border rounded-lg overflow-hidden shadow-md flex flex-col h-full relative no-transform transition-all duration-300"].filter(Boolean).join(" "),children:[e.jsxs("div",{className:"w-full aspect-square overflow-hidden relative bg-gray-100",children:[e.jsx("div",{className:"absolute top-0 left-0 h-1 bg-orange-500 z-50 transition-all duration-300",style:{width:`${y}%`,opacity:o?0:1}}),e.jsx("div",{className:"absolute inset-0 bg-cover bg-center opacity-50 blur-lg transition-opacity duration-300",style:{backgroundImage:`url(${N[0].lowResSrc})`,zIndex:10,opacity:o?0:.5}}),e.jsx(B,{images:N,alt:t.name,loading:"lazy",className:"w-full h-full relative z-20 transition-opacity duration-500",onFullyLoaded:p})]}),e.jsxs("div",{className:"bg-white/90 py-3 px-4 flex-grow flex flex-col justify-between border-t border-gray-200",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-1",children:t.name}),e.jsxs("div",{className:"flex gap-1 text-xs text-orange-500 mb-1",children:[t.category_ref&&e.jsx("span",{children:t.category_ref.name}),t.anime&&e.jsxs("span",{children:["• ",t.anime.name]})]}),e.jsxs("span",{className:"text-lg font-bold text-orange-500 block mb-1",children:["C$",t.price.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-2",children:t.description})]}),e.jsxs("button",{onClick:()=>v(t),className:"w-full bg-black text-white py-2 px-2 rounded-md flex items-center justify-center gap-1 hover:bg-gray-800 transition-colors","aria-label":`Agregar ${t.name} al carrito`,children:[e.jsx(A,{size:16}),"Agregar"]})]})]})}function V({error:t,resetErrorBoundary:g}){return d.useEffect(()=>{console.error("StoreFront Component Error:",t)},[t]),e.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),e.jsx("p",{className:"text-red-500",children:t.message}),e.jsx("button",{onClick:g,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function K(){return e.jsx(M,{FallbackComponent:V,onReset:()=>{window.history.go(0)},children:e.jsx("main",{className:"store-front",children:e.jsx(G,{})})})}function G(){var w;const[t,g]=d.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1}));d.useEffect(()=>{const n=()=>{g({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})};return window.addEventListener("reset-store-filters",n),()=>{window.removeEventListener("reset-store-filters",n)}},[]);const v=d.useCallback(async()=>{var a,i;const[n,s]=await Promise.all([k.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),k.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),c=((a=n.data)==null?void 0:a.filter(u=>u.products.length>0).map(u=>({id:u.id,name:u.name})))||[],r=((i=s.data)==null?void 0:i.filter(u=>u.products.length>0).map(u=>({id:u.id,name:u.name})))||[];return{categoriesWithProducts:c,animesWithProducts:r}},[]),y=async n=>{try{const s=n.trim().toLowerCase(),c=[];c.push(`name.ilike.%${s}%`),c.push(`description.ilike.%${s}%`),c.push(`category.ilike.%${s}%`);const{data:r}=await k.from("anime").select("id").ilike("name",`%${s}%`).limit(1);return r&&r.length>0&&c.push(`anime_id.eq.${r[0].id}`),c.length>0?c.join(","):""}catch(s){return console.error("Error en búsqueda flexible:",s),""}},b=d.useCallback(async({pageParam:n=1})=>{try{const c=window.innerWidth<768?6:12,r=(n-1)*c,a=r+c-1;let i=k.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(t.search&&t.search.trim()!==""){const S=t.search.toLowerCase().trim();try{const F=await y(S);F&&(i=i.or(F))}catch(F){console.error("Error en búsqueda de productos:",F)}}t.category&&t.category.trim()!==""&&(i=i.eq("category_id",t.category)),t.anime&&t.anime.trim()!==""&&(i=i.eq("anime_id",t.anime)),t.minPrice!==void 0&&(i=i.gte("price",t.minPrice)),t.maxPrice!==void 0&&(i=i.lte("price",t.maxPrice)),i=i.order(t.sortBy.split("_")[0],{ascending:t.sortBy.endsWith("_asc")});const{data:u,error:P,count:C}=await i.range(r,a);if(P)throw P;const I=C?Math.ceil(C/c):0;return{products:u||[],totalPages:I}}catch(s){return console.error("🚨 Error en búsqueda de productos:",s),{products:[],totalPages:0}}},[t]),{data:o,isLoading:f,error:l,isError:x,refetch:h}=_({queryKey:["products",t],queryFn:async()=>{const{categoriesWithProducts:n,animesWithProducts:s}=await v(),c=await b({pageParam:t.page||1});return{categoriesWithProducts:n,animesWithProducts:s,...c}},placeholderData:n=>n,staleTime:5e3,gcTime:1e4,refetchOnWindowFocus:!1,refetchOnMount:!1,refetchOnReconnect:!1}),N=d.useCallback(n=>{g(s=>({...s,...n}))},[]),p=n=>{g(s=>({...s,page:n}))},m=()=>{g({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:void 0,maxPrice:void 0,page:1})},j=()=>{const n=(o==null?void 0:o.totalPages)||0,s=t.page||1;if(n<=1)return null;const r=s<=3?Array.from({length:Math.min(5,n)},(i,u)=>u+1):s>=n-2?Array.from({length:5},(i,u)=>n-5+u+1):[s-2,s-1,s,s+1,s+2];return e.jsx("div",{className:"fixed bottom-0 left-0 right-0 flex justify-center items-center p-4 z-50",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("button",{onClick:()=>p(s-1),disabled:s===1,className:"px-3 py-2 rounded-md disabled:opacity-50 transition-colors",children:"←"}),r.map(a=>e.jsx("button",{onClick:()=>p(a),className:`px-4 py-2 rounded-md transition-all duration-150 ease-in-out ${s===a?"bg-blue-500 text-white transform scale-110":"bg-gray-200 hover:bg-blue-100"} ${a<1||a>n?"hidden":""}`,children:a},a)),e.jsx("button",{onClick:()=>p(s+1),disabled:s===n,className:"px-3 py-2 rounded-md disabled:opacity-50 transition-colors",children:"→"})]})})};return e.jsx("div",{className:"relative min-h-screen bg-white overflow-hidden",children:e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10",children:[e.jsx(R,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, mangas, accesorios y más."}),e.jsx("div",{className:"mb-8 bg-gray-50 rounded-lg shadow-md p-6",children:f?e.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):e.jsx(T,{onFilterChange:N,currentFilters:t,categories:(o==null?void 0:o.categoriesWithProducts)||[],animes:(o==null?void 0:o.animesWithProducts)||[],onResetFilters:m})}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-4 transition-all duration-300 ease-in-out transform",children:(w=o==null?void 0:o.products)==null?void 0:w.map((n,s)=>e.jsx("div",{className:"transition-all duration-300",style:{transitionDelay:`${s*50}ms`,willChange:"transform, opacity"},children:e.jsx(O,{product:n})},n.id))}),j()]})})}export{K as default};
