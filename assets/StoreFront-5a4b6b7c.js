import{r as p,j as e,k as w,S as $,D as C,X as k,M,P as _,E,G as z}from"./vendor-2e0792b2.js";import{a as P,s as y,S as B}from"./index-97c69941.js";import{I as O}from"./ImageCarousel-a57e97b1.js";function R(r){return(Array.isArray(r)?r:[r]).filter(i=>i&&i.trim()!=="").map(i=>{try{return[{descriptor:"320w",width:320},{descriptor:"640w",width:640},{descriptor:"1024w",width:1024},{descriptor:"1920w",width:1920}].map(t=>`${i} ${t.descriptor}`).join(", ")}catch(n){return console.error("Error generating WebP srcset:",n),i}})}function T({onFilterChange:r,currentFilters:d={},categories:h,animes:i}){const[n,t]=p.useState(d),u=s=>{console.log("handleFilterChange - Received new filters:",s),console.log("Current currentFilters:",d);const a={...d,...s};t(a),r(a)},g=s=>{u({category:s.target.value===""?void 0:s.target.value})},o=s=>{u({anime:s.target.value===""?void 0:s.target.value})},b=s=>{const a=s.target.value?parseFloat(s.target.value):void 0;u({minPrice:a})},f=s=>{const a=s.target.value?parseFloat(s.target.value):void 0;u({maxPrice:a})},x=s=>{u({sortBy:s.target.value})},N=s=>{const a=s.target.value;console.log("Search value:",a),t(c=>({...c,search:a===""?void 0:a})),r({search:a===""?void 0:a})},l=()=>{t({}),r({})};return e.jsxs("div",{className:"search-and-filters grid grid-cols-1 md:grid-cols-3 gap-4","aria-label":"Filtros de búsqueda",children:[e.jsx("div",{className:"filter-group",children:e.jsx("input",{type:"text",placeholder:"Buscar productos...",value:n.search||"",onChange:N,"aria-label":"Buscar productos por nombre o descripción",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md"})}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"category-select",className:"block text-sm font-medium text-gray-700",children:"Categoría"}),e.jsxs("select",{id:"category-select",value:n.category||"",onChange:g,"aria-label":"Seleccionar categoría de producto",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Todas las categorías"}),h.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"anime-select",className:"block text-sm font-medium text-gray-700",children:"Anime"}),e.jsxs("select",{id:"anime-select",value:n.anime||"",onChange:o,"aria-label":"Seleccionar anime",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"",children:"Todos los Animes"}),i.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"min-price-input",className:"block text-sm font-medium text-gray-700",children:"Precio Mínimo"}),e.jsx("input",{id:"min-price-input",type:"number",placeholder:"Precio mínimo",value:n.minPrice||"",onChange:b,"aria-label":"Filtrar productos por precio mínimo",min:"0",step:"0.01",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"max-price-input",className:"block text-sm font-medium text-gray-700",children:"Precio Máximo"}),e.jsx("input",{id:"max-price-input",type:"number",placeholder:"Precio máximo",value:n.maxPrice,onChange:f,"aria-label":"Filtrar productos por precio máximo",min:"0",step:"0.01",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md"})]}),e.jsxs("div",{className:"filter-group",children:[e.jsx("label",{htmlFor:"sort-select",className:"block text-sm font-medium text-gray-700",children:"Ordenar por"}),e.jsxs("select",{id:"sort-select",value:n.sortBy||"name_asc",onChange:x,"aria-label":"Ordenar productos",className:"mt-1 block w-full p-2 border border-gray-300 rounded-md",children:[e.jsx("option",{value:"name_asc",children:"Nombre A-Z"}),e.jsx("option",{value:"name_desc",children:"Nombre Z-A"}),e.jsx("option",{value:"price_asc",children:"Precio: Menor a Mayor"}),e.jsx("option",{value:"price_desc",children:"Precio: Mayor a Menor"}),e.jsx("option",{value:"created_at",children:"Fecha de creación"})]})]}),Object.keys(n).length>0&&e.jsx("div",{className:"col-span-full",children:e.jsx("button",{onClick:l,"aria-label":"Restablecer filtros",className:"w-full p-2 bg-gray-200 rounded hover:bg-gray-300 transition-colors",children:"Restablecer Filtros"})})]})}function W({product:r,className:d}){const{addItem:h}=P(),i=w.useMemo(()=>{if(!r.images||r.images.length===0)return["https://via.placeholder.com/400x400?text=No+Image"];const t=r.images.filter(u=>u&&u.trim()!=="");return t.length>0?t:["https://via.placeholder.com/400x400?text=No+Image"]},[r.images]),n=w.useMemo(()=>R(i),[i]);return e.jsxs("div",{className:[d,"product-card border rounded-lg overflow-hidden shadow-md hover:shadow-lg transition-shadow duration-300 flex flex-col h-full"].filter(Boolean).join(" "),children:[e.jsx("div",{className:"w-full aspect-square",children:e.jsx("div",{className:"w-full h-full object-cover",children:e.jsx(O,{images:i,alt:r.name,srcSet:n.join(", "),loading:"lazy"})})}),e.jsxs("div",{className:"p-3 flex-grow flex flex-col justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-lg font-bold text-gray-900 mb-1",children:r.name}),e.jsxs("div",{className:"flex gap-1 text-xs text-orange-500 mb-1",children:[r.category_ref&&e.jsx("span",{children:r.category_ref.name}),r.anime&&e.jsxs("span",{children:["• ",r.anime.name]})]}),e.jsxs("span",{className:"text-lg font-bold text-orange-500 block mb-1",children:["C$",r.price.toFixed(2)]}),e.jsx("p",{className:"text-xs text-gray-600 mb-2 line-clamp-2",children:r.description})]}),e.jsxs("button",{onClick:()=>h(r),className:"w-full bg-black text-white py-1 px-2 rounded-md hover:bg-gray-900 transition-colors flex items-center justify-center gap-1 text-xs","aria-label":`Agregar ${r.name} al carrito`,children:[e.jsx($,{size:16}),"Agregar"]})]})]})}function I(){const{items:r,removeItem:d,updateQuantity:h,total:i,isOpen:n,setIsOpen:t,clearCart:u}=P(),g=()=>{const o=r.map(x=>`• ${x.quantity}x ${x.product.name} - C$${(x.product.price*x.quantity).toFixed(2)}`).join(`
`),b=`

Total: C$${i.toFixed(2)}`,f=encodeURIComponent(`¡Hola! Me gustaría ordenar:
${o}${b}`);window.open(`https://wa.me/50578364365?text=${f}`,"_blank"),u()};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>t(!0),className:"fixed bottom-4 right-4 z-50 bg-black text-white p-3 rounded-full shadow-lg hover:bg-gray-900 transition-colors","aria-label":"Abrir carrito",children:e.jsxs("div",{className:"relative",children:[e.jsx(C,{size:24}),r.length>0&&e.jsx("span",{className:"absolute -top-2 -right-2 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center",children:r.length})]})}),n&&e.jsxs("div",{className:"fixed inset-0 z-50 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-50",onClick:()=>t(!1)}),e.jsx("div",{className:"fixed inset-y-0 right-0 max-w-full flex",children:e.jsx("div",{className:"w-screen max-w-md",children:e.jsxs("div",{className:"h-full flex flex-col bg-white shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center p-4 border-b",children:[e.jsxs("h2",{className:"text-lg font-semibold flex items-center",children:[e.jsx(C,{className:"mr-2"}),"Carrito de Compras"]}),e.jsx("button",{onClick:()=>t(!1),className:"p-2 hover:bg-gray-100 rounded-full","aria-label":"Cerrar carrito",children:e.jsx(k,{})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto p-4",children:r.length===0?e.jsx("p",{className:"text-center text-gray-500",children:"El carrito está vacío"}):e.jsx("ul",{className:"space-y-4",children:r.map(o=>e.jsxs("li",{className:"flex items-center space-x-4 bg-white rounded-lg p-2 shadow-sm",children:[e.jsx("img",{src:o.product.images[0]||"https://via.placeholder.com/100",alt:o.product.name,className:"w-16 h-16 object-cover rounded"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h3",{className:"font-medium truncate",children:o.product.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:["C$",o.product.price.toFixed(2)]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsx("button",{onClick:()=>h(o.product.id,o.quantity-1),className:"p-1 hover:bg-gray-100 rounded","aria-label":"Reducir cantidad",children:e.jsx(M,{size:16})}),e.jsx("span",{className:"w-8 text-center",children:o.quantity}),e.jsx("button",{onClick:()=>h(o.product.id,o.quantity+1),className:"p-1 hover:bg-gray-100 rounded","aria-label":"Aumentar cantidad",children:e.jsx(_,{size:16})})]})]}),e.jsx("button",{onClick:()=>d(o.product.id),className:"p-2 hover:bg-gray-100 rounded-full flex-shrink-0","aria-label":"Eliminar del carrito",children:e.jsx(k,{size:20})})]},o.product.id))})}),r.length>0&&e.jsxs("div",{className:"border-t p-4 bg-white",children:[e.jsxs("div",{className:"flex justify-between items-center font-semibold mb-4",children:[e.jsx("span",{children:"Total:"}),e.jsxs("span",{children:["C$",i.toFixed(2)]})]}),e.jsx("button",{onClick:g,className:"w-full bg-black text-white py-3 px-4 rounded-lg hover:bg-gray-900 transition-colors",children:"Ordenar por WhatsApp"})]})]})})})]})]})}function q({error:r,resetErrorBoundary:d}){return p.useEffect(()=>{console.error("StoreFront Component Error:",r)},[r]),e.jsxs("div",{role:"alert",className:"p-4 text-center bg-red-100",children:[e.jsx("h2",{className:"text-xl font-bold text-red-600",children:"Error Loading Store Front"}),e.jsx("p",{className:"text-red-500",children:r.message}),e.jsx("button",{onClick:d,className:"mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600",children:"Try Again"})]})}function Q(){return e.jsx(E,{FallbackComponent:q,onReset:()=>{window.history.go(0)},children:e.jsx(L,{})})}function L(){const[r,d]=p.useState(()=>({search:"",category:"",anime:"",sortBy:"name_asc",minPrice:0,maxPrice:void 0,page:1})),h=p.useCallback(async()=>{var v,j;const[l,s]=await Promise.all([y.from("categories").select(`
          id, 
          name, 
          products:products(id)
        `),y.from("anime").select(`
          id, 
          name, 
          products:products(id)
        `)]),a=((v=l.data)==null?void 0:v.filter(m=>m.products.length>0).map(m=>({id:m.id,name:m.name})))||[],c=((j=s.data)==null?void 0:j.filter(m=>m.products.length>0).map(m=>({id:m.id,name:m.name})))||[];return{categoriesWithProducts:a,animesWithProducts:c}},[]),i=async l=>{const{data:s}=await y.from("anime").select("id").ilike("name",`%${l}%`).single(),a=[`name.ilike.%${l}%`,`description.ilike.%${l}%`,`category.ilike.%${l}%`];return s!=null&&s.id&&a.push(`anime_id.eq.${s.id}`),a.join(",")},n=p.useCallback(async({pageParam:l=1})=>{try{const s=(l-1)*5,a=s+5-1;let c=y.from("products").select("*, categories(id, name), anime(id, name)",{count:"exact"});if(r.search&&r.search.trim()!==""){const A=r.search.toLowerCase().trim(),S=await i(A);c=c.or(S)}r.category&&r.category.trim()!==""&&(c=c.eq("category_id",r.category)),r.anime&&r.anime.trim()!==""&&(c=c.eq("anime_id",r.anime)),c=c.order(r.sortBy.split("_")[0],{ascending:r.sortBy.endsWith("_asc")});const{data:v,error:j,count:m}=await c.range(s,a);if(j)throw j;const F=m?Math.ceil(m/5):0;return{products:v||[],totalPages:F}}catch(s){return console.error("🚨 Error en búsqueda de productos:",s),{products:[],totalPages:0}}},[r]),{data:t,refetch:u,isLoading:g,error:o}=z(["storefront-data",r],async()=>{const{categoriesWithProducts:l,animesWithProducts:s}=await h(),a=await n({pageParam:r.page||1});return{categoriesWithProducts:l,animesWithProducts:s,...a}},{keepPreviousData:!0,staleTime:5e3}),b=p.useCallback(l=>{d(s=>({...s,...l}))},[]),f=l=>{d(s=>({...s,page:l}))},x=()=>g?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-orange-500"})}):o?e.jsx("div",{className:"text-center text-red-500 py-8",children:"Error al cargar productos"}):t!=null&&t.products.length?e.jsx("div",{className:`grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4
                    gap-2 sm:gap-3 md:gap-4 
                    w-full px-1 sm:px-2 md:px-4`,children:t.products.map(l=>e.jsx(W,{product:l,className:"w-full h-full"},l.id))}):e.jsx("div",{className:"text-center text-gray-500 py-8",children:"No hay productos disponibles"}),N=()=>{const l=(t==null?void 0:t.totalPages)||0,s=r.page||1;return l<=1?null:e.jsx("div",{className:"flex justify-center mt-8 space-x-2",children:Array.from({length:l},(a,c)=>c+1).map(a=>e.jsx("button",{onClick:()=>f(a),className:`px-4 py-2 rounded-md ${s===a?"bg-blue-500 text-white":"bg-gray-200"}`,children:a},a))})};return e.jsxs("div",{className:"bg-white min-h-screen",children:[e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsx(B,{title:"GATOTAKU - Tu Tienda de Anime",description:"Descubre nuestra colección de productos de anime. Figuras, mangas, accesorios y más."}),e.jsx("div",{className:"mb-8 bg-gray-50 rounded-lg shadow-md p-6",children:g?e.jsx("h1",{className:"text-3xl font-bold text-gray-800 border-b-2 border-orange-200 pb-2",children:"GATOTAKU"}):e.jsx(T,{categories:(t==null?void 0:t.categoriesWithProducts)||[],animes:(t==null?void 0:t.animesWithProducts)||[],currentFilters:r,onFilterChange:b})}),x(),N()]}),e.jsx(I,{})]})}export{Q as default};
